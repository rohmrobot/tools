<!doctype html>
<html lang="th" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ | Equipment Borrowing System</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="https://static.vecteezy.com/system/resources/previews/009/400/627/non_2x/tool-clipart-design-illustration-free-png.png"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { sans: ["Kanit", "sans-serif"] },
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
              },
              dark: { bg: "#0f172a", card: "#1e293b", text: "#f1f5f9" },
            },
          },
        },
      };
    </script>

    <style>
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
      .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
      }
      .dark .glass {
        background: rgba(30, 41, 59, 0.9);
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .swal2-popup {
        font-family: "Kanit", sans-serif !important;
      }
      .swal2-container.swal2-top-end {
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        right: auto !important;
        bottom: auto !important;
      }
      .no-spinner::-webkit-inner-spin-button,
      .no-spinner::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .no-spinner {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300 min-h-screen flex flex-col"
  >
    <script>
      // ‡∏•‡∏¥‡∏á‡∏Å‡πå Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbw8ssHPXkmML0yMsKXP2Qr03K-zk-TlQiD-hPNVQmRqAUhOpnZMJhrYGGOARNsb2YM/exec";

      window.APP_CONFIG = {
        useGoogleSheets: false,
        adminId: "9999",
        storageKeys: {
          user: "ems_user_fb",
          theme: "ems_theme",
          localData: "ems_data_inventory",
          localLogs: "ems_data_logs",
        },
      };

      window.handleImageError = (img) => {
        img.onerror = null;
        img.src = "https://placehold.co/300x200?text=No+Image";
      };

      window.formatGoogleDriveLink = (url) => {
        if (!url) return "";
        const idMatch = url.match(/[-\w]{25,}/);
        if (idMatch && (url.includes('drive.google.com') || url.includes('docs.google.com'))) {
          return `https://drive.google.com/thumbnail?id=${idMatch[0]}&sz=w800`;
        }
        return url;
      };

      // Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Loader ‡∏ú‡πà‡∏≤‡∏ô SweetAlert2
      window.showLoader = (title = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...") => {
        Swal.fire({
          title: title,
          allowOutsideClick: false,
          allowEscapeKey: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
      };

      window.hideLoader = () => {
        Swal.close();
      };
    </script>

    <div
      id="saving-indicator"
      class="fixed bottom-4 right-4 z-[60] bg-white dark:bg-dark-card shadow-lg rounded-full px-4 py-2 text-xs font-medium text-gray-500 hidden flex items-center gap-2 border border-gray-100 dark:border-gray-700"
    >
      <i class="fas fa-circle-notch fa-spin text-primary-500"></i>
      <span id="saving-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
    </div>

    <div
      id="login-screen"
      class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-primary-600 to-blue-800 p-4 hidden"
    >
      <div
        class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all fade-in"
      >
        <div class="text-center mb-8">
          <div
            class="bg-primary-100 dark:bg-primary-900 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-primary-600 dark:text-primary-300 shadow-inner"
          >
            <i class="fas fa-toolbox text-3xl"></i>
          </div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
            ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å-‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
          </h1>
          <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">
            Equipment Management System (Firebase)
          </p>
        </div>
        <form id="login-form" class="space-y-5">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
              >‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label
            >
            <div class="relative">
              <i
                class="fas fa-id-card absolute left-3 top-3.5 text-gray-400"
              ></i>
              <input
                type="text"
                id="login-id"
                required
                class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none transition"
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 9999)"
              />
            </div>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
              >‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label
            >
            <div class="relative">
              <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
              <input
                type="text"
                id="login-name"
                required
                class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none transition"
                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
              />
            </div>
          </div>

          <button
            type="submit"
            class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3.5 rounded-lg shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2"
          >
            <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </form>
      </div>
    </div>

    <div id="app-screen" class="hidden flex flex-col min-h-screen">
      <nav
        class="sticky top-0 z-40 glass border-b border-gray-200 dark:border-gray-700 shadow-sm"
      >
        <div class="w-full px-4">
          <div class="flex justify-between h-16">
            <div class="flex items-center gap-3">
              <div
                class="bg-primary-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md"
              >
                <i class="fas fa-wrench text-sm"></i>
              </div>
              <div class="flex flex-col justify-center">
                <span class="font-bold text-lg leading-tight tracking-tight"
                  >Tools<span class="text-primary-600 dark:text-primary-400"
                    >Master</span
                  ></span
                >
                <div class="flex items-center gap-2">
                  <span
                    class="text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wide"
                    >Borrow system</span
                  >
                  <span
                    class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
                    title="Online"
                  ></span>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button
                onclick="toggleTheme()"
                class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 hover:text-orange-500 dark:hover:text-yellow-400 transition flex items-center justify-center"
              >
                <i class="fas fa-moon dark:hidden"></i
                ><i class="fas fa-sun hidden dark:block"></i>
              </button>
              <div class="relative group z-50">
                <button class="flex items-center gap-2 pl-2">
                  <div class="text-right hidden sm:block">
                    <p
                      id="user-display-name"
                      class="text-sm font-semibold text-gray-900 dark:text-white truncate max-w-[120px]"
                    >
                      User
                    </p>
                    <p
                      id="user-display-role"
                      class="text-xs text-gray-500 dark:text-gray-400"
                    >
                      Staff
                    </p>
                  </div>
                  <div
                    class="w-9 h-9 rounded-full bg-primary-100 dark:bg-primary-900 border-2 border-white dark:border-gray-600 flex items-center justify-center text-primary-600 dark:text-primary-300"
                  >
                    <i class="fas fa-user text-sm"></i>
                  </div>
                </button>
                <div
                  class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl py-2 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all transform origin-top-right border border-gray-100 dark:border-gray-700"
                >
                  <div
                    class="px-4 py-2 border-b border-gray-100 dark:border-gray-700 sm:hidden"
                  >
                    <p
                      class="text-sm font-bold text-gray-900 dark:text-white"
                      id="mobile-user-name"
                    >
                      User
                    </p>
                    <p class="text-xs text-gray-500" id="mobile-user-role">
                      Staff
                    </p>
                  </div>
                  <button
                    onclick="DataService.loadData()"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
                  >
                    <i class="fas fa-sync-alt mr-2 text-blue-500"></i>
                    ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                  </button>
                  <button
                    onclick="logout()"
                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
                  >
                    <i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <div
        class="bg-white dark:bg-dark-card shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-16 z-30"
      >
        <div class="w-full px-4">
          <div class="flex space-x-2 overflow-x-auto no-scrollbar py-2">
            <button
              onclick="switchTab('dashboard')"
              id="tab-dashboard"
              class="tab-btn hidden flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20"
            >
              <i class="fas fa-chart-pie"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            </button>

            <button
              onclick="switchTab('inventory')"
              id="tab-inventory"
              class="tab-btn active-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all"
            >
              <i class="fas fa-box-open"></i> ‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á
            </button>
            <button
              onclick="switchTab('my-items')"
              id="tab-my-items"
              class="tab-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all relative"
            >
              <i class="fas fa-hand-holding"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏∑‡∏°
              <span
                id="my-items-badge"
                class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800"
                >0</span
              >
            </button>
            <button
              onclick="switchTab('verify')"
              id="tab-verify"
              class="tab-btn hidden flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all relative text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20"
            >
              <i class="fas fa-tasks"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
              <span
                id="verify-badge"
                class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800"
                >0</span
              >
            </button>
            <button
              onclick="switchTab('history')"
              id="tab-history"
              class="tab-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all"
            >
              <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </button>
            <button
              onclick="switchTab('admin')"
              id="tab-admin"
              class="tab-btn hidden flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20"
            >
              <i class="fas fa-cog"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å
            </button>
          </div>
        </div>
      </div>

      <main class="flex-1 w-full px-4 py-6 pb-24">
        <div id="view-dashboard" class="hidden fade-in">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
              <i class="fas fa-chart-line text-indigo-500"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
              (Dashboard)
            </h2>

            <div
              class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6 flex flex-col sm:flex-row justify-between items-center gap-4"
            >
              <div class="flex items-center gap-3">
                <div
                  class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-full text-orange-600 dark:text-orange-400"
                >
                  <i class="fas fa-server text-xl"></i>
                </div>
                <div>
                  <h3
                    class="font-bold text-gray-700 dark:text-gray-200 text-sm"
                  >
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
                  </h3>
                  <p class="text-xs text-gray-500 dark:text-gray-400">
                    ‡∏î‡∏π‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î (Free Tier) ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà
                    Firebase Console
                  </p>
                </div>
              </div>
              <a
                href="https://console.firebase.google.com/u/0/project/borrow-tools-system/firestore/databases/-default-/usage/prev-24h"
                target="_blank"
                class="w-full sm:w-auto text-center bg-indigo-50 text-indigo-600 hover:bg-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-400 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 whitespace-nowrap"
              >
                <i class="fas fa-external-link-alt"></i> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Console
              </a>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-blue-500"
              >
                <div class="text-xs text-gray-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
                <div class="text-2xl font-bold" id="stat-total-items">0</div>
              </div>
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-green-500"
              >
                <div class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="text-2xl font-bold" id="stat-total-logs">0</div>
              </div>
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-yellow-500"
              >
                <div class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</div>
                <div class="text-2xl font-bold" id="stat-active-borrows">0</div>
              </div>
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-indigo-500"
              >
                <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                <div class="text-2xl font-bold" id="stat-users-count">-</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm">
                <h3
                  class="font-bold mb-4 text-sm text-gray-700 dark:text-gray-300"
                >
                  üèÜ ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 5)
                </h3>
                <div class="relative h-64">
                  <canvas id="chart-users"></canvas>
                </div>
              </div>

              <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm">
                <h3
                  class="font-bold mb-4 text-sm text-gray-700 dark:text-gray-300"
                >
                  üì¶ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï (Top 5)
                </h3>
                <div class="relative h-64">
                  <canvas id="chart-items"></canvas>
                </div>
              </div>
            </div>

            <div
              class="mt-6 bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden"
            >
              <div
                class="px-6 py-4 border-b border-gray-100 dark:border-gray-700"
              >
                <h3 class="font-bold text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
              </div>
              <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h4 class="text-green-600 font-bold text-xs uppercase mb-2">
                    üî• ‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                  </h4>
                  <ul id="list-most-borrowed" class="space-y-2 text-sm"></ul>
                </div>
                <div>
                  <h4 class="text-red-500 font-bold text-xs uppercase mb-2">
                    ‚ùÑÔ∏è ‡∏¢‡∏∑‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Zero Use)
                  </h4>
                  <ul
                    id="list-least-borrowed"
                    class="space-y-2 text-sm text-gray-500"
                  ></ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="view-inventory" class="fade-in">
          <div
            class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
          >
            <h2
              class="text-xl font-bold flex items-center gap-2 whitespace-nowrap"
            >
              <i class="fas fa-search text-primary-500"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </h2>
            <div class="flex w-full md:w-auto gap-2">
              <div class="relative w-1/3 md:w-48">
                <select
                  id="filter-category"
                  class="w-full appearance-none pl-4 pr-8 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-primary-500 outline-none shadow-sm cursor-pointer"
                >
                  <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                </select>
                <i
                  class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 pointer-events-none text-xs"
                ></i>
              </div>
              <div class="relative w-2/3 md:w-64">
                <input
                  type="text"
                  id="search-inventory"
                  placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..."
                  class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-primary-500 outline-none shadow-sm text-sm"
                />
                <i
                  class="fas fa-search absolute left-3 top-3.5 text-gray-400"
                ></i>
              </div>
            </div>
          </div>
          <div
            id="inventory-grid"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 sm:gap-6"
          ></div>
        </div>

        <div id="view-my-items" class="hidden fade-in">
          <div class="flex justify-between items-end mb-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏∑‡∏°
              </h2>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
              </p>
            </div>
            <div class="flex gap-2">
              <button
                onclick="returnAllItems()"
                id="btn-return-all"
                class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm shadow-md transition flex items-center gap-2"
              >
                <i class="fas fa-undo-alt"></i> ‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </button>
            </div>
          </div>
          <div class="mb-6">
            <h3
              class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200 border-l-4 border-primary-500 pl-3"
            >
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏° (Active)
            </h3>
            <div
              id="my-items-active-list"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            ></div>
            <div
              id="my-items-active-empty"
              class="hidden text-center py-6 text-gray-400 text-sm bg-gray-50 dark:bg-gray-800 rounded-xl"
            >
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°
            </div>
          </div>
          <div>
            <h3
              class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200 border-l-4 border-yellow-500 pl-3"
            >
              ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Pending Confirmation)
            </h3>
            <div
              id="my-items-pending-list"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            ></div>
            <div
              id="my-items-pending-empty"
              class="hidden text-center py-6 text-gray-400 text-sm bg-gray-50 dark:bg-gray-800 rounded-xl"
            >
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </div>
          </div>
        </div>

        <div id="view-verify" class="hidden fade-in">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á</h2>
            <button
              onclick="verifyAllReturns()"
              id="btn-verify-all"
              class="hidden bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm shadow-md transition flex items-center gap-2"
            >
              <i class="fas fa-check-double"></i> ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
          <div
            id="verify-list"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
          ></div>
          <div
            id="verify-empty"
            class="hidden text-center py-12 bg-white dark:bg-dark-card rounded-xl border border-dashed border-gray-300 dark:border-gray-700"
          >
            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
          </div>
        </div>

        <div id="view-history" class="hidden fade-in">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
            <div>
              <span
                class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-gray-500 mr-2"
                id="history-filter-label"
                >‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span
              >
              <button
                onclick="deleteSelectedLogs()"
                id="btn-bulk-delete"
                class="hidden bg-red-100 hover:bg-red-200 text-red-600 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-400 px-3 py-1.5 rounded-lg text-xs font-bold transition"
              >
                <i class="fas fa-trash-alt mr-1"></i> ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              </button>
            </div>
          </div>
          <div
            class="bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700 overflow-x-auto"
          >
            <table class="w-full text-sm text-left">
              <thead
                id="history-table-head"
                class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 border-b dark:border-gray-600"
              ></thead>
              <tbody
                id="history-table-body"
                class="divide-y divide-gray-200 dark:divide-gray-700"
              ></tbody>
            </table>
          </div>
        </div>

        <div id="view-admin" class="hidden fade-in">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
            <button
              onclick="openAddModal()"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow text-sm"
            >
              <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </button>
          </div>
          <div
            class="bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700 overflow-x-auto"
          >
            <table class="w-full text-sm text-left">
              <thead
                class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 border-b dark:border-gray-600"
              >
                <tr>
                  <th class="px-4 py-3 w-16 text-center">‡∏£‡∏π‡∏õ</th>
                  <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                  <th class="px-4 py-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                  <th class="px-4 py-3 text-center">Stock</th>
                  <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody
                id="admin-table-body"
                class="divide-y divide-gray-200 dark:divide-gray-700"
              ></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <div
      id="borrow-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm p-4"
    >
      <div
        class="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl shadow-2xl p-6"
      >
        <div class="flex gap-4 mb-4">
          <img
            id="borrow-img-preview"
            src=""
            referrerpolicy="no-referrer"
            class="w-20 h-20 rounded-lg object-cover bg-gray-100"
            onerror="handleImageError(this)"
          />
          <div>
            <h3
              class="text-lg font-bold text-gray-900 dark:text-white leading-tight mb-1"
              id="borrow-item-name"
            ></h3>
            <p class="text-xs text-gray-500">
              ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:
              <span
                id="borrow-item-max"
                class="font-bold text-primary-600 text-base"
              ></span>
            </p>
          </div>
        </div>
        <div class="flex items-center justify-center gap-4 mb-6">
          <button
            onclick="adjustQty(-1)"
            class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700"
          >
            <i class="fas fa-minus"></i>
          </button>
          <input
            type="number"
            id="borrow-qty"
            min="1"
            value="1"
            readonly
            class="w-16 text-center text-2xl font-bold bg-transparent outline-none no-spinner"
          />
          <button
            onclick="adjustQty(1)"
            class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700"
          >
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button
            onclick="closeModal('borrow-modal')"
            class="py-3 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-500"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button
            id="btn-confirm-borrow"
            onclick="confirmBorrow()"
            class="py-3 rounded-xl bg-primary-600 text-white font-bold shadow-lg"
          >
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>

    <div
      id="item-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm p-4"
    >
      <div
        class="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-2xl p-6 overflow-y-auto max-h-[90vh]"
      >
        <h3 id="item-modal-title" class="text-lg font-bold mb-4">
          ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        </h3>
        <form id="item-form" class="space-y-4">
          <input type="hidden" id="item-id" />

          <div>
            <label class="block text-sm mb-2 font-medium">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
            <div class="flex gap-4 mb-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="img-source"
                  value="file"
                  checked
                  class="text-primary-600"
                  onchange="toggleImageSource('file')"
                />
                <span class="text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="img-source"
                  value="url"
                  class="text-primary-600"
                  onchange="toggleImageSource('url')"
                />
                <span class="text-sm">‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</span>
              </label>
            </div>

            <div
              class="flex items-start gap-4 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800"
            >
              <div
                class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden border flex-shrink-0 relative group"
              >
                <img
                  id="item-image-preview"
                  src="https://placehold.co/100?text=Preview"
                  referrerpolicy="no-referrer"
                  class="w-full h-full object-cover"
                  onerror="handleImageError(this)"
                />
                <div
                  id="upload-loading-spinner"
                  class="absolute inset-0 bg-black/50 flex items-center justify-center hidden"
                >
                  <i class="fas fa-circle-notch fa-spin text-white"></i>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div id="input-type-file">
                  <label
                    class="cursor-pointer bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-600 transition shadow-sm w-full justify-center"
                  >
                    <i class="fas fa-camera"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    <input
                      type="file"
                      id="item-image-file"
                      accept="image/*"
                      class="hidden"
                    />
                  </label>
                  <p class="text-xs text-gray-400 mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG</p>
                </div>
                <div id="input-type-url" class="hidden">
                  <input
                    type="url"
                    id="item-image-url"
                    placeholder="https://example.com/image.jpg"
                    class="w-full px-3 py-2 text-sm border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 outline-none"
                  />
                  <p class="text-xs text-gray-400 mt-2">
                    ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô
                  </p>
                </div>
                <!-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Base64 ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á GAS -->
                <input type="hidden" id="item-image-temp-base64" />
              </div>
            </div>
          </div>

          <input
            type="text"
            id="item-name"
            required
            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700"
          />
          <div class="grid grid-cols-2 gap-4">
            <div>
              <input
                type="text"
                list="category-list"
                id="item-category"
                placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"
                class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700"
              />
              <datalist id="category-list"></datalist>
            </div>
            <input
              type="number"
              id="item-stock"
              min="1"
              required
              placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Stock"
              class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700"
            />
          </div>
          <div class="flex justify-end gap-3 pt-4">
            <button
              type="button"
              onclick="closeModal('item-modal')"
              class="px-4 py-2 text-gray-500"
            >
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-primary-600 text-white rounded-lg shadow"
            >
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDocs,
        getDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        query,
        where,
        orderBy,
        runTransaction,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import {
        initializeAppCheck,
        ReCaptchaEnterpriseProvider,
        getToken,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js";

      // --- FIREBASE CONFIGURATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyCqP4PJZjifXa96NLdJ5Dd9A9AWLYcIiqs",
        authDomain: "borrow-tools-system.firebaseapp.com",
        projectId: "borrow-tools-system",
        storageBucket: "borrow-tools-system.firebasestorage.app",
        messagingSenderId: "1027262105690",
        appId: "1:1027262105690:web:0db3c601e67ef04a303063",
      };

      // --- APP CHECK CONFIG ---
      const RECAPTCHA_SITE_KEY = "6Le8BUQsAAAAADL6dXL-Tso7Q13aJgOVAQSmLqi0";

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î Timeout ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Promise
      const withTimeout = (promise, ms, errorMessage = "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î") => {
        let timeoutId;
        const timeoutPromise = new Promise((_, reject) => {
          timeoutId = setTimeout(() => {
            reject(new Error(errorMessage));
          }, ms);
        });

        return Promise.race([promise, timeoutPromise]).finally(() => {
          clearTimeout(timeoutId);
        });
      };

      // --- GLOBAL STATE ---
      window.currentUser = null;
      window.inventoryData = [];
      window.transactionLogs = [];
      window.currentBorrowItemId = null;
      let app, db;

      // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï
      window.addEventListener('offline', () => {
        Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 5000
        });
      });

      window.addEventListener('online', () => {
        Swal.fire({
          icon: 'success',
          title: '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß',
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000
        });
      });

      // --- BOOTSTRAP SYSTEM ---
      async function bootstrapSystem() {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
        if (!navigator.onLine) {
          Swal.fire({
            icon: "error",
            title: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠",
            text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö",
          });
          document.getElementById("login-screen").classList.remove("hidden");
          return;
        }

        window.showLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...");

        // --- APP CHECK DEBUG CONFIG (LOCAL) ---
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ localhost:
        // 1. ‡∏Å‡πä‡∏≠‡∏õ‡∏£‡∏´‡∏±‡∏™ UUID ‡∏à‡∏≤‡∏Å Console ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase Console (App Check > Manage debug tokens)
        // 2. ‡∏´‡∏≤‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏Ç‡∏∂‡πâ‡∏ô 403 ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ UUID ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ true ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô:
        // self.FIREBASE_APPCHECK_DEBUG_TOKEN = '12345678-abcd-efgh-ijkl-123456789012';
        self.FIREBASE_APPCHECK_DEBUG_TOKEN = true; 

        try {
          app = initializeApp(firebaseConfig);

          if (RECAPTCHA_SITE_KEY) {
            const appCheck = initializeAppCheck(app, {
              provider: new ReCaptchaEnterpriseProvider(RECAPTCHA_SITE_KEY),
              isTokenAutoRefreshEnabled: true,
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Token ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î 403 ‡πÅ‡∏•‡∏∞ Timeout
            try {
              const tokenResponse = await withTimeout(
                getToken(appCheck),
                15000,
                "App Check ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Timeout)"
              );
              console.log("Firebase App Check Verified:", tokenResponse);
            } catch (error) {
              console.error("App Check Internal Error:", error);
              // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ 403 Forbidden
              if (error.message.includes("403") || error.stack.includes("403")) {
                 throw new Error("<b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (403)</b><br><br>1. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ UUID ‡πÉ‡∏ô Browser Console<br>2. ‡∏ô‡∏≥‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π App Check ‡∏Ç‡∏≠‡∏á Firebase Console<br>3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô App Check API ‡πÉ‡∏ô Google Cloud Console ‡πÅ‡∏•‡πâ‡∏ß");
              } else {
                throw error;
              }
            }
          }

          db = getFirestore(app);
          console.log("Firebase Connected");

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°
          const storedUser = localStorage.getItem(window.APP_CONFIG.storageKeys.user);
          if (storedUser) {
            initApp(JSON.parse(storedUser));
          } else {
            document.getElementById("login-screen").classList.remove("hidden");
            document.getElementById("app-screen").classList.add("hidden");
          }
          
          window.hideLoader();

        } catch (error) {
          console.error("System Bootstrap Error:", error);
          
          window.hideLoader();
          
          // ‡∏î‡∏µ‡∏î‡∏≠‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å Error
          document.getElementById("login-screen").classList.remove("hidden");
          document.getElementById("app-screen").classList.add("hidden");

          setTimeout(() => {
            Swal.fire({
              icon: "error",
              title: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
              html: error.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ reCAPTCHA ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
              confirmButtonText: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö",
              allowOutsideClick: false
            }).then(() => {
              // ‡∏•‡πâ‡∏≤‡∏á Session ‡∏´‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ
              localStorage.removeItem(window.APP_CONFIG.storageKeys.user);
              // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ 403 ‡∏´‡∏£‡∏∑‡∏≠ Error ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ö‡∏ô localhost ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏î refresh ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡πâ config
              // location.reload(); 
            });
          }, 200);
        }
      }

      // --- EXPORT FUNCTIONS ---
      window.switchTab = switchTab;
      window.closeModal = (id) =>
        document.getElementById(id).classList.add("hidden");
      window.toggleTheme = toggleTheme;
      window.adjustQty = (n) => {
        const el = document.getElementById("borrow-qty");
        let v = parseInt(el.value) + n;
        let max = parseInt(el.max || 1);
        if (v < 1) v = 1;
        if (v > max) v = max;
        el.value = v;
      };

      window.DataService = {
        loadData: () => {
          const icon = document.querySelector(".fa-sync-alt");
          if (icon) {
            icon.classList.add("fa-spin");
            setTimeout(() => icon.classList.remove("fa-spin"), 1000);
          }
        },
        saveData: async () => true,
      };

      // --- AUTH ---
      window.login = async (e) => {
        e.preventDefault();
        const inputId = document.getElementById("login-id").value.trim();
        const inputName = document.getElementById("login-name").value.trim();
        if (!inputId) return;

        window.showLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...");

        try {
          const q = query(
            collection(db, "users"),
            where("empId", "==", inputId),
          );
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const userData = querySnapshot.docs[0].data();
            const user = {
              empId: userData.empId,
              name: userData.name,
              isAdmin: userData.role === "admin",
            };
            localStorage.setItem("ems_user_fb", JSON.stringify(user));
            initApp(user);
          } else {
            const newUser = {
              empId: inputId,
              name: inputName || `User ${inputId}`,
              role: inputId === "9999" ? "admin" : "user",
            };
            try {
              await addDoc(collection(db, "users"), newUser);
            } catch (err) {
              console.warn("Auto-register failed:", err);
            }
            const user = { ...newUser, isAdmin: newUser.role === "admin" };
            localStorage.setItem("ems_user_fb", JSON.stringify(user));
            initApp(user);
          }
          window.hideLoader();
        } catch (err) {
          console.error(err);
          window.hideLoader();
          Swal.fire("Login Error", "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Config Firebase ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠", "error");
        }
      };
      document
        .getElementById("login-form")
        .addEventListener("submit", window.login);

      window.logout = () => {
        localStorage.removeItem("ems_user_fb");
        location.reload();
      };

      function initApp(user) {
        window.currentUser = user;
        document.getElementById("user-display-name").innerText = user.name;
        document.getElementById("user-display-role").innerText = user.isAdmin
          ? "Admin"
          : "User";
        const mobileName = document.getElementById("mobile-user-name");
        if (mobileName) mobileName.innerText = user.name;
        const mobileRole = document.getElementById("mobile-user-role");
        if (mobileRole) mobileRole.innerText = user.isAdmin ? "Admin" : "User";

        const adminTab = document.getElementById("tab-admin");
        const verifyTab = document.getElementById("tab-verify");
        const dashboardTab = document.getElementById("tab-dashboard");

        if (user.isAdmin) {
          adminTab.classList.remove("hidden");
          verifyTab.classList.remove("hidden");
          dashboardTab.classList.remove("hidden");
        } else {
          adminTab.classList.add("hidden");
          verifyTab.classList.add("hidden");
          dashboardTab.classList.add("hidden");
        }

        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("app-screen").classList.remove("hidden");

        startRealtimeListeners();
        switchTab("inventory");
      }

      // --- REALTIME LISTENERS ---
      function startRealtimeListeners() {
        onSnapshot(collection(db, "inventory"), (snapshot) => {
          window.inventoryData = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          renderInventory();
          if (window.currentUser.isAdmin) {
            renderAdminTable();
            renderDashboard();
          }
          populateCategories();
        });

        onSnapshot(collection(db, "logs"), (snapshot) => {
          window.transactionLogs = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          renderHistory();
          renderMyItems();
          if (window.currentUser.isAdmin) {
            renderVerify();
            renderDashboard();
          }
        });
      }

      // --- DASHBOARD LOGIC ---
      let usersChartInstance = null;
      let itemsChartInstance = null;

      function renderDashboard() {
        if (!window.currentUser.isAdmin) return;
        const totalItems = window.inventoryData.reduce(
          (sum, i) => sum + i.stock,
          0,
        );
        const totalLogs = window.transactionLogs.length;
        const activeBorrows = window.transactionLogs.filter(
          (l) => l.status === "borrowed",
        ).length;
        const uniqueUsers = new Set(window.transactionLogs.map((l) => l.empId))
          .size;

        document.getElementById("stat-total-items").innerText = totalItems;
        document.getElementById("stat-total-logs").innerText = totalLogs;
        document.getElementById("stat-active-borrows").innerText =
          activeBorrows;
        document.getElementById("stat-users-count").innerText = uniqueUsers;

        const userCounts = {};
        const itemCounts = {};
        window.transactionLogs.forEach((log) => {
          userCounts[log.borrowerName] =
            (userCounts[log.borrowerName] || 0) + 1;
          itemCounts[log.itemName] = (itemCounts[log.itemName] || 0) + 1;
        });

        const topUsers = Object.entries(userCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        const topItems = Object.entries(itemCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        renderChart(
          "chart-users",
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°",
          topUsers,
          "rgba(54, 162, 235, 0.6)",
        );
        renderChart(
          "chart-items",
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°",
          topItems,
          "rgba(255, 206, 86, 0.6)",
        );

        const allItemsSorted = Object.entries(itemCounts).sort(
          (a, b) => b[1] - a[1],
        );
        const mostBorrowedList = document.getElementById("list-most-borrowed");
        const leastBorrowedList = document.getElementById(
          "list-least-borrowed",
        );

        mostBorrowedList.innerHTML = allItemsSorted
          .slice(0, 3)
          .map(
            ([name, count]) =>
              `<li class="flex justify-between"><span>${name}</span><span class="font-bold">${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></li>`,
          )
          .join("");

        const zeroBorrows = window.inventoryData.filter(
          (i) => !itemCounts[i.name],
        );
        leastBorrowedList.innerHTML =
          zeroBorrows
            .slice(0, 3)
            .map(
              (i) =>
                `<li class="flex justify-between"><span>${i.name}</span><span class="text-xs bg-gray-100 px-2 rounded">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></li>`,
            )
            .join("") ||
          '<li class="text-gray-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</li>';
      }

      function renderChart(canvasId, label, dataEntries, color) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        if (canvasId === "chart-users" && usersChartInstance)
          usersChartInstance.destroy();
        if (canvasId === "chart-items" && itemsChartInstance)
          itemsChartInstance.destroy();

        const chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: dataEntries.map((e) => e[0]),
            datasets: [
              {
                label: label,
                data: dataEntries.map((e) => e[1]),
                backgroundColor: color,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1, precision: 0 },
              },
            },
          },
        });

        if (canvasId === "chart-users") usersChartInstance = chart;
        if (canvasId === "chart-items") itemsChartInstance = chart;
      }

      // --- CORE LOGIC ---
      window.openBorrowModal = (id) => {
        const item = window.inventoryData.find((i) => i.id == id);
        if (!item) return;
        window.currentBorrowItemId = id;
        document.getElementById("borrow-item-name").innerText = item.name;
        document.getElementById("borrow-item-max").innerText = item.remaining;
        document.getElementById("borrow-img-preview").src =
          item.image || "https://placehold.co/100";
        document.getElementById("borrow-qty").max = item.remaining;
        document.getElementById("borrow-qty").value = 1;
        document.getElementById("borrow-modal").classList.remove("hidden");
      };

      window.confirmBorrow = async () => {
        const qty = parseInt(document.getElementById("borrow-qty").value);
        const itemId = window.currentBorrowItemId;
        const btn = document.getElementById("btn-confirm-borrow");
        btn.disabled = true;
        btn.innerText = "...";

        try {
          await runTransaction(db, async (transaction) => {
            const itemRef = doc(db, "inventory", itemId);
            const itemDoc = await transaction.get(itemRef);
            if (!itemDoc.exists()) throw "Item does not exist!";
            const currentRemaining = itemDoc.data().remaining;
            if (currentRemaining < qty) throw "‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!";
            transaction.update(itemRef, { remaining: currentRemaining - qty });
            const newLogRef = doc(collection(db, "logs"));
            transaction.set(newLogRef, {
              itemId: itemId,
              itemName: itemDoc.data().name,
              borrowerName: window.currentUser.name,
              empId: window.currentUser.empId,
              borrowDate: new Date().toISOString(),
              status: "borrowed",
              qty: qty,
              returnDate: null,
            });
          });
          closeModal("borrow-modal");
          Swal.fire({
            icon: "success",
            title: "‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            timer: 1500,
            showConfirmButton: false,
          });
        } catch (e) {
          Swal.fire("Error", e.toString(), "error");
        } finally {
          btn.disabled = false;
          btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
        }
      };

      window.requestReturn = async (logId) => {
        const result = await Swal.fire({
          title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô?",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        });
        if (result.isConfirmed) {
          try {
            await updateDoc(doc(db, "logs", logId), {
              status: "pending_return",
            });
          } catch (e) {
            console.error(e);
          }
        }
      };

      window.returnAllItems = async () => {
        const result = await Swal.fire({
          title: "‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        });
        if (result.isConfirmed) {
          const batch = writeBatch(db);
          let count = 0;
          window.transactionLogs.forEach((log) => {
            if (
              log.empId == window.currentUser.empId &&
              log.status === "borrowed"
            ) {
              batch.update(doc(db, "logs", log.id), {
                status: "pending_return",
              });
              count++;
            }
          });
          if (count > 0) await batch.commit();
        }
      };

      window.adminConfirmReturn = async (logId) => {
        try {
          await runTransaction(db, async (transaction) => {
            const logRef = doc(db, "logs", logId);
            const logDoc = await transaction.get(logRef);
            if (!logDoc.exists()) throw "Log not found";
            const logData = logDoc.data();
            const itemRef = doc(db, "inventory", logData.itemId);
            const itemDoc = await transaction.get(itemRef);
            transaction.update(logRef, {
              status: "returned",
              returnDate: new Date().toISOString(),
            });
            if (itemDoc.exists()) {
              transaction.update(itemRef, {
                remaining: (itemDoc.data().remaining || 0) + logData.qty,
              });
            }
          });
        } catch (e) {
          Swal.fire("Error", e.toString(), "error");
        }
      };

      window.verifyAllReturns = async () => {
        const pending = window.transactionLogs.filter(
          (l) => l.status === "pending_return",
        );
        for (const log of pending) await window.adminConfirmReturn(log.id);
        Swal.fire({
          icon: "success",
          title: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
          timer: 1500,
          showConfirmButton: false,
        });
      };

      window.deleteLog = async (logId) => {
        const result = await Swal.fire({
          title: "‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?",
          text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Stock ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£",
        });
        if (result.isConfirmed) {
          try {
            await deleteDoc(doc(db, "logs", logId));
            Swal.fire({
              icon: "success",
              title: "‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              timer: 1000,
              showConfirmButton: false,
            });
          } catch (e) {
            Swal.fire(
              "Error",
              "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Rules)",
              "error",
            );
          }
        }
      };

      window.toggleSelectAll = (source) => {
        const checkboxes = document.querySelectorAll(".log-checkbox");
        checkboxes.forEach((cb) => (cb.checked = source.checked));
      };

      window.deleteSelectedLogs = async () => {
        const checkboxes = document.querySelectorAll(".log-checkbox:checked");
        if (checkboxes.length === 0) {
          Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö", "warning");
          return;
        }

        const result = await Swal.fire({
          title: `‡∏•‡∏ö ${checkboxes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`,
          text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Stock ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        });

        if (result.isConfirmed) {
          try {
            const batch = writeBatch(db);
            checkboxes.forEach((cb) => {
              const ref = doc(db, "logs", cb.value);
              batch.delete(ref);
            });
            await batch.commit();
            Swal.fire({
              icon: "success",
              title: "‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              timer: 1000,
              showConfirmButton: false,
            });
          } catch (e) {
            Swal.fire("Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", "error");
          }
        }
      };

      // --- GAS UPLOAD HELPER ---
      async function uploadImageToGAS(base64Data, fileName) {
        if (!base64Data || !base64Data.startsWith("data:image")) {
          return base64Data; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà base64 (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
        }

        const response = await fetch(GAS_API_URL, {
          redirect: "follow",
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify({
            action: "uploadImage",
            image: base64Data,
            name: fileName
          })
        });

        if (!response.ok) throw new Error("Network response was not ok");
        
        const result = await response.json();
        if (result.status === "success") return result.url;
        throw new Error(result.message || "Upload to Google Drive failed");
      }

      // --- ADMIN: ITEM MANAGEMENT ---
      document
        .getElementById("item-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          
          window.showLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

          const id = document.getElementById("item-id").value;
          const name = document.getElementById("item-name").value;
          const category = document.getElementById("item-category").value;
          const stock = parseInt(document.getElementById("item-stock").value);

          const sourceType = document.querySelector(
            'input[name="img-source"]:checked',
          ).value;
          
          let image = "";
          try {
            if (sourceType === "file") {
              const base64 = document.getElementById("item-image-temp-base64").value;
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (Base64) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              if (base64 && base64.startsWith("data:image")) {
                // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà GAS ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore
                image = await uploadImageToGAS(base64, `${name}_${Date.now()}.jpg`);
              } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô URL ‡∏à‡∏≤‡∏Å Drive)
                image = document.getElementById("item-image-preview").src;
              }
            } else {
              const url = document.getElementById("item-image-url").value;
              image = window.formatGoogleDriveLink(url);
            }
            
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏π‡∏õ‡∏ß‡πà‡∏≤‡∏á
            if (!image || image.includes("placehold.co") || image === "") {
               image = "https://placehold.co/300x200?text=No+Image";
            }

            const itemData = { name, category, stock, image };

            if (id) {
              const oldItem = window.inventoryData.find((i) => i.id == id);
              const borrowed = oldItem.stock - oldItem.remaining;
              itemData.remaining = stock - borrowed;
              await updateDoc(doc(db, "inventory", id), itemData);
            } else {
              itemData.remaining = stock;
              await addDoc(collection(db, "inventory"), itemData);
            }
            
            closeModal("item-modal");
            Swal.fire({
              icon: "success",
              title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
              timer: 1500,
              showConfirmButton: false,
            });
          } catch (error) {
            console.error("Save Error:", error);
            Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ", "error");
          } finally {
            window.hideLoader();
          }
        });

      window.toggleImageSource = (type) => {
        document
          .getElementById("input-type-file")
          .classList.toggle("hidden", type !== "file");
        document
          .getElementById("input-type-url")
          .classList.toggle("hidden", type !== "url");
      };

      document
        .getElementById("item-image-url")
        .addEventListener("input", (e) => {
          if (e.target.value)
            document.getElementById("item-image-preview").src = window.formatGoogleDriveLink(e.target.value);
        });

      window.openAddModal = () => {
        document.getElementById("item-modal-title").innerText =
          "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà";
        document.getElementById("item-form").reset();
        document.getElementById("item-id").value = "";
        document.getElementById("item-image-temp-base64").value = "";
        document.getElementById("item-image-preview").src =
          "https://placehold.co/100?text=Preview";
        document.querySelector(
          'input[name="img-source"][value="file"]',
        ).checked = true;
        window.toggleImageSource("file");
        document.getElementById("item-modal").classList.remove("hidden");
      };

      window.editItem = (id) => {
        const item = window.inventoryData.find((i) => i.id == id);
        document.getElementById("item-modal-title").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå";
        document.getElementById("item-id").value = id;
        document.getElementById("item-name").value = item.name;
        document.getElementById("item-category").value = item.category;
        document.getElementById("item-stock").value = item.stock;
        document.getElementById("item-image-temp-base64").value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤

        const isUrl =
          item.image &&
          item.image.startsWith("http") &&
          !item.image.startsWith("data:");
        
        document.querySelector(
          `input[name="img-source"][value="${isUrl ? "url" : "file"}"]`,
        ).checked = true;
        window.toggleImageSource(isUrl ? "url" : "file");

        if (isUrl) {
          document.getElementById("item-image-url").value = item.image;
        }

        document.getElementById("item-image-preview").src =
          item.image || "https://placehold.co/100";
        document.getElementById("item-modal").classList.remove("hidden");
      };

      window.deleteItem = async (id) => {
        const item = window.inventoryData.find((i) => i.id == id);
        const result = await Swal.fire({
          title: "‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?",
          text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Google Drive ‡∏î‡πâ‡∏ß‡∏¢",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "‡∏•‡∏ö",
        });

        if (result.isConfirmed) {
          window.showLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
          try {
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Google Drive ‡∏ú‡πà‡∏≤‡∏ô GAS
            if (item && item.image && (item.image.includes("drive.google.com") || item.image.includes("googleusercontent.com/d/"))) {
              // ‡∏î‡∏∂‡∏á File ID ‡∏à‡∏≤‡∏Å URL
              const fileIdMatch = item.image.match(/id=([-\w]{25,})|d\/([-\w]{25,})/);
              const actualFileId = fileIdMatch ? (fileIdMatch[1] || fileIdMatch[2]) : null;

              if (actualFileId) {
                await fetch(GAS_API_URL, {
                  redirect: "follow",
                  method: "POST",
                  headers: { "Content-Type": "text/plain;charset=utf-8" },
                  body: JSON.stringify({
                    action: "deleteImage",
                    fileId: actualFileId
                  })
                });
                console.log("Drive file deleted:", actualFileId);
              }
            }

            // 2. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firestore
            await deleteDoc(doc(db, "inventory", id));

            Swal.fire({
              icon: "success",
              title: "‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              timer: 1000,
              showConfirmButton: false,
            });
          } catch (error) {
            console.error("Delete error:", error);
            Swal.fire("Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: " + error.message, "error");
          } finally {
            window.hideLoader();
          }
        }
      };

      // --- RENDER FUNCTIONS ---
      function renderInventory() {
        const grid = document.getElementById("inventory-grid");
        const search = document
          .getElementById("search-inventory")
          .value.toLowerCase();
        const catFilter = document.getElementById("filter-category").value;
        grid.innerHTML = "";
        const items = window.inventoryData.filter((i) => {
          const matchName = i.name.toLowerCase().includes(search);
          const matchCat = catFilter ? i.category === catFilter : true;
          return matchName && matchCat;
        });
        items.forEach((item) => {
          const isOut = item.remaining <= 0;
          const cardClass = isOut
            ? "bg-white dark:bg-dark-card rounded-2xl border border-gray-100 dark:border-gray-700 flex flex-col h-full overflow-hidden opacity-60"
            : "bg-white dark:bg-dark-card rounded-2xl shadow-sm hover:shadow-md transition border border-gray-100 dark:border-gray-700 flex flex-col h-full group overflow-hidden";

          grid.innerHTML += `
                    <div class="${cardClass}">
                        <div class="h-40 overflow-hidden relative bg-gray-100 dark:bg-gray-800">
                            <img src="${item.image}" referrerpolicy="no-referrer" class="w-full h-full object-cover ${isOut ? "" : "group-hover:scale-105 transition duration-500"}" onerror="handleImageError(this)">
                            <span class="absolute top-2 right-2 px-2 py-1 text-xs font-bold rounded-full ${isOut ? "bg-red-500 text-white" : "bg-green-500 text-white"} shadow-sm">
                                ${isOut ? "‡∏´‡∏°‡∏î" : `‡∏ß‡πà‡∏≤‡∏á ${item.remaining}`}
                            </span>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <div class="text-xs text-gray-400 mb-1">${item.category || "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"}</div>
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg mb-1 leading-snug line-clamp-2">${item.name}</h3>
                            <div class="flex-1"></div>
                            <button onclick="openBorrowModal('${item.id}')" ${isOut ? "disabled" : ""} class="mt-4 w-full py-2.5 rounded-xl font-medium transition flex items-center justify-center gap-2 ${isOut ? "bg-gray-100 text-gray-400 cursor-not-allowed" : "bg-primary-600 text-white hover:bg-primary-700 shadow-lg"}">
                                ${isOut ? "‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î" : "‡∏¢‡∏∑‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ"}
                            </button>
                        </div>
                    </div>`;
        });
      }

      function renderMyItems() {
        const activeList = document.getElementById("my-items-active-list");
        const pendingList = document.getElementById("my-items-pending-list");
        const badge = document.getElementById("my-items-badge");
        const returnAllBtn = document.getElementById("btn-return-all");

        activeList.innerHTML = "";
        pendingList.innerHTML = "";

        const myLogs = window.transactionLogs.filter(
          (l) => l.empId == window.currentUser.empId,
        );
        const active = myLogs.filter((l) => l.status === "borrowed");
        const pending = myLogs.filter((l) => l.status === "pending_return");

        document
          .getElementById("my-items-active-empty")
          .classList.toggle("hidden", active.length > 0);
        document
          .getElementById("my-items-pending-empty")
          .classList.toggle("hidden", pending.length > 0);

        if (active.length > 0) {
          badge.classList.remove("hidden");
          badge.innerText = active.length;
          returnAllBtn.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
          returnAllBtn.classList.add("hidden");
        }

        const createCard = (log, isActive) => {
          const item =
            window.inventoryData.find((i) => i.id == log.itemId) || {};
          const date = new Date(log.borrowDate).toLocaleDateString("th-TH");
          const btn = isActive
            ? `<button onclick="requestReturn('${log.id}')" class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow"><i class="fas fa-undo"></i></button>`
            : `<div class="text-yellow-500 text-xl"><i class="fas fa-clock"></i></div>`;

          return `
                    <div class="bg-white dark:bg-dark-card p-4 rounded-xl border-l-4 ${isActive ? "border-primary-500" : "border-yellow-500"} shadow-sm flex items-center gap-4">
                        <img src="${item.image || "https://placehold.co/100"}" referrerpolicy="no-referrer" class="w-16 h-16 rounded-lg object-cover bg-gray-100" onerror="handleImageError(this)">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-900 dark:text-white truncate">${log.itemName}</h4>
                            <div class="text-xs text-gray-500 mt-1">‡∏¢‡∏∑‡∏°: ${date}</div>
                            <div class="mt-2"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-md font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${log.qty}</span></div>
                        </div>
                        ${btn}
                    </div>`;
        };

        active.forEach((l) => (activeList.innerHTML += createCard(l, true)));
        pending.forEach((l) => (pendingList.innerHTML += createCard(l, false)));
      }

      function renderVerify() {
        const list = document.getElementById("verify-list");
        const badge = document.getElementById("verify-badge");
        const verifyAllBtn = document.getElementById("btn-verify-all");
        list.innerHTML = "";
        const pending = window.transactionLogs.filter(
          (l) => l.status === "pending_return",
        );

        if (pending.length > 0) {
          badge.classList.remove("hidden");
          badge.innerText = pending.length;
          verifyAllBtn.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
          verifyAllBtn.classList.add("hidden");
        }
        document
          .getElementById("verify-empty")
          .classList.toggle("hidden", pending.length > 0);

        pending.forEach((log) => {
          const item =
            window.inventoryData.find((i) => i.id == log.itemId) || {};
          list.innerHTML += `
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-md overflow-hidden border border-yellow-200">
                        <div class="flex p-4 gap-4">
                            <img src="${item.image || "https://placehold.co/100"}" referrerpolicy="no-referrer" class="w-20 h-20 rounded-lg object-cover" onerror="handleImageError(this)">
                            <div class="flex-1">
                                <h4 class="font-bold dark:text-white">${log.itemName}</h4>
                                <div class="text-sm text-gray-500">${log.borrowerName} (${log.empId})</div>
                                <div class="text-xs text-gray-400 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${log.qty}</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 flex justify-end">
                            <button onclick="adminConfirmReturn('${log.id}')" class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-sm flex items-center gap-2"><i class="fas fa-check"></i> ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</button>
                        </div>
                    </div>`;
        });
      }

      function renderHistory() {
        const thead = document.getElementById("history-table-head");
        const tbody = document.getElementById("history-table-body");
        tbody.innerHTML = "";

        let headerHtml = "";
        if (window.currentUser.isAdmin) {
          headerHtml += `<th class="px-4 py-3 w-10 text-center"><input type="checkbox" onchange="toggleSelectAll(this)" class="rounded text-primary-600 focus:ring-primary-500 cursor-pointer"></th>`;
        }
        headerHtml += `
                <th class="px-4 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th>
                <th class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
                <th class="px-4 py-3">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                <th class="px-4 py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="px-4 py-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th>
            `;
        thead.innerHTML = `<tr>${headerHtml}</tr>`;

        let logs = window.transactionLogs;
        if (!window.currentUser.isAdmin)
          logs = logs.filter((l) => l.empId == window.currentUser.empId);
        logs.sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate));

        const bulkBtn = document.getElementById("btn-bulk-delete");
        if (bulkBtn)
          bulkBtn.classList.toggle("hidden", !window.currentUser.isAdmin);

        logs.forEach((log) => {
          const status =
            log.status === "borrowed"
              ? '<span class="text-blue-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</span>'
              : log.status === "pending_return"
                ? '<span class="text-yellow-500 font-medium animate-pulse">‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô</span>'
                : '<span class="text-green-500 font-medium">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';

          const borrowDateTime = new Date(log.borrowDate).toLocaleString(
            "th-TH",
            { dateStyle: "short", timeStyle: "short" },
          );
          const returnDateTime = log.returnDate
            ? new Date(log.returnDate).toLocaleString("th-TH", {
                dateStyle: "short",
                timeStyle: "short",
              })
            : "-";

          let checkCell = "";
          let deleteBtn = "";

          if (window.currentUser.isAdmin) {
            checkCell = `<td class="px-4 py-3 text-center"><input type="checkbox" class="log-checkbox rounded text-primary-600 focus:ring-primary-500 cursor-pointer" value="${log.id}"></td>`;
            deleteBtn = `<button onclick="deleteLog('${log.id}')" class="text-red-400 hover:text-red-600 ml-2" title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"><i class="fas fa-trash-alt"></i></button>`;
          }

          tbody.innerHTML += `
                    <tr class="bg-white dark:bg-dark-card border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">${checkCell}<td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${borrowDateTime}</td><td class="px-4 py-3"><div class="font-medium text-gray-900 dark:text-white">${log.borrowerName}</div><div class="text-[11px] text-gray-400 font-light mt-0.5">ID: ${log.empId}</div></td><td class="px-4 py-3 text-gray-800 dark:text-gray-200">${log.itemName}</td><td class="px-4 py-3 text-center font-bold text-gray-700 dark:text-gray-300">${log.qty}</td><td class="px-4 py-3 text-center text-sm">${status}</td><td class="px-4 py-3 text-center text-sm text-gray-500 whitespace-nowrap">${returnDateTime}${deleteBtn}</td></tr>`;
        });
      }

      function renderAdminTable() {
        const tbody = document.getElementById("admin-table-body");
        tbody.innerHTML = "";
        window.inventoryData.forEach((item) => {
          tbody.innerHTML += `
                    <tr class="bg-white border-b dark:bg-dark-card dark:border-gray-700">
                        <td class="px-4 py-3 text-center"><img src="${item.image}" referrerpolicy="no-referrer" class="w-10 h-10 rounded object-cover mx-auto" onerror="handleImageError(this)"></td>
                        <td class="px-4 py-3">${item.name}</td>
                        <td class="px-4 py-3">${item.category}</td>
                        <td class="px-4 py-3 text-center">${item.remaining}/${item.stock}</td>
                        <td class="px-4 py-3 text-center space-x-2">
                            <button onclick="editItem('${item.id}')" class="text-primary-600"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem('${item.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
        });
      }

      function populateCategories() {
        const select = document.getElementById("filter-category");
        const dl = document.getElementById("category-list");
        select.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
        dl.innerHTML = "";
        const cats = [
          ...new Set(
            window.inventoryData.map((i) => i.category).filter(Boolean),
          ),
        ];
        cats.forEach((c) => {
          select.innerHTML += `<option value="${c}">${c}</option>`;
          dl.innerHTML += `<option value="${c}">`;
        });
      }

      document
        .getElementById("search-inventory")
        .addEventListener("input", renderInventory);
      document
        .getElementById("filter-category")
        .addEventListener("change", renderInventory);

      // --- UTILS ---
      function resizeImage(file, maxWidth = 600) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement("canvas");
              let w = img.width,
                h = img.height;
              if (w > maxWidth) {
                h = Math.round((h * maxWidth) / w);
                w = maxWidth;
              }
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL("image/jpeg", 0.7));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      document
        .getElementById("item-image-file")
        .addEventListener("change", async (e) => {
          if (e.target.files[0]) {
            const base64 = await resizeImage(e.target.files[0]);
            document.getElementById("item-image-preview").src = base64;
            document.getElementById("item-image-temp-base64").value = base64;
          }
        });

      function switchTab(tab) {
        document.querySelectorAll(".tab-btn").forEach((b) => {
          b.classList.remove(
            "active-tab",
            "bg-primary-50",
            "text-primary-600",
            "dark:bg-primary-900/30",
            "dark:text-primary-400",
            "bg-yellow-50",
            "text-yellow-600",
            "dark:text-yellow-400",
          );
          if (b.id === "tab-verify") {
            b.classList.remove(
              "text-yellow-600",
              "dark:text-yellow-400",
              "bg-yellow-50",
              "dark:bg-yellow-900/20",
            );
          } else if (b.id === "tab-dashboard") {
            b.classList.remove(
              "text-indigo-600",
              "dark:text-indigo-400",
              "bg-indigo-50",
              "dark:bg-indigo-900/20",
            );
          }
          b.classList.add("text-gray-500", "dark:text-gray-400");
        });

        const btn = document.getElementById(`tab-${tab}`);
        btn.classList.remove("text-gray-500", "dark:text-gray-400");

        if (tab === "verify")
          btn.classList.add(
            "active-tab",
            "bg-yellow-50",
            "text-yellow-600",
            "dark:bg-yellow-900/30",
            "dark:text-yellow-400",
          );
        else if (tab === "dashboard")
          btn.classList.add(
            "active-tab",
            "bg-indigo-50",
            "text-indigo-600",
            "dark:bg-indigo-900/30",
            "dark:text-indigo-400",
          );
        else
          btn.classList.add(
            "active-tab",
            "bg-primary-50",
            "text-primary-600",
            "dark:bg-primary-900/30",
            "dark:text-primary-400",
          );

        [
          "inventory",
          "my-items",
          "verify",
          "history",
          "admin",
          "dashboard",
        ].forEach((v) => {
          document
            .getElementById(`view-${v}`)
            .classList.toggle("hidden", v !== tab);
        });

        if (tab === "my-items") renderMyItems();
        if (tab === "history") renderHistory();
        if (tab === "verify") renderVerify();
        if (tab === "dashboard") renderDashboard();
      }

      function toggleTheme() {
        const html = document.documentElement;
        if (html.classList.contains("dark")) {
          html.classList.remove("dark");
          localStorage.setItem(APP_CONFIG.storageKeys.theme, "light");
        } else {
          html.classList.add("dark");
          localStorage.setItem(APP_CONFIG.storageKeys.theme, "dark");
        }
      }

      // --- INITIALIZATION ---
      bootstrapSystem();
    </script>
  </body>
</html>
