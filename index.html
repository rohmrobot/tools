<!doctype html>
<html lang="th" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ | Equipment Borrowing System</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="https://static.vecteezy.com/system/resources/previews/009/400/627/non_2x/tool-clipart-design-illustration-free-png.png"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Added flatpickr for better date picking experience -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { sans: ["Kanit", "sans-serif"] },
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                900: "#0c4a6e",
              },
              dark: {
                bg: "#0f172a", // Slate 900
                card: "#1e293b", // Slate 800
                text: "#e2e8f0", // Slate 200
                muted: "#94a3b8", // Slate 400
              },
            },
          },
        },
      };
    </script>

    <style>
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #334155;
      }
      .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
      }
      .dark .glass {
        background: rgba(15, 23, 42, 0.9);
        border-bottom-color: #334155;
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .swal2-popup {
        font-family: "Kanit", sans-serif !important;
      }
      .dark .swal2-popup {
        background: #1e293b !important;
        color: #e2e8f0 !important;
      }
      .swal2-container.swal2-top-end {
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        right: auto !important;
        bottom: auto !important;
      }
      .no-spinner::-webkit-inner-spin-button,
      .no-spinner::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .no-spinner {
        -moz-appearance: textfield;
      }
      /* Image Zoom Transition */
      .zoom-enter {
        transform: scale(0.9);
        opacity: 0;
      }
      .zoom-enter-active {
        transform: scale(1);
        opacity: 1;
        transition: all 0.2s ease-out;
      }

      /* Continuous Seamless Marquee */
      .marquee-wrapper {
        position: relative;
        overflow: hidden;
        white-space: nowrap;
        mask-image: linear-gradient(
          to right,
          transparent 0%,
          black 5%,
          black 95%,
          transparent 100%
        );
      }

      .marquee-content {
        display: inline-flex;
        animation: seamless-marquee 10s linear infinite;
      }

      @keyframes seamless-marquee {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-50%);
        }
      }

      /* Selection Highlight Style */
      .card-selected {
        border-color: #0ea5e9 !important; /* primary-500 */
        background-color: #f0f9ff !important; /* primary-50 */
        box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.2);
      }
      .dark .card-selected {
        border-color: #0ea5e9 !important;
        background-color: rgba(
          12,
          74,
          110,
          0.4
        ) !important; /* primary-900 / 40% */
      }
      .dropdown-visible {
        visibility: visible !important;
        opacity: 1 !important;
        transform: scale(1) !important;
      }

      /* Flatpickr Dark Mode Support */
      .dark .flatpickr-calendar {
        background: #1e293b;
        border-color: #334155;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      }
      .dark .flatpickr-day {
        color: #e2e8f0;
      }
      .dark .flatpickr-day.nextMonthDay,
      .dark .flatpickr-day.prevMonthDay {
        color: #475569;
      }
      .dark .flatpickr-day:hover {
        background: #334155;
      }
      .dark .flatpickr-months .flatpickr-month,
      .dark .flatpickr-current-month,
      .dark .flatpickr-current-month input.cur-year {
        color: #e2e8f0;
        fill: #e2e8f0;
      }
      .dark .flatpickr-weekday {
        color: #94a3b8;
      }
      .dark .flatpickr-day.selected {
        background: #0ea5e9;
        border-color: #0ea5e9;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300 min-h-screen flex flex-col"
  >
    <script>
      // ‡∏•‡∏¥‡∏á‡∏Å‡πå Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
      const GAS_API_URL =
        "https://script.google.com/macros/s/AKfycbw8ssHPXkmML0yMsKXP2Qr03K-zk-TlQiD-hPNVQmRqAUhOpnZMJhrYGGOARNsb2YM/exec";

      window.APP_CONFIG = {
        storageKeys: {
          user: "ems_user_fb",
          theme: "ems_theme",
        },
      };

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î Dropdown ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
      window.toggleProfileDropdown = (event) => {
        if (event) event.stopPropagation();
        const dropdown = document.getElementById("profile-dropdown-menu");
        dropdown.classList.toggle("dropdown-visible");
      };

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Dropdown (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
      window.closeProfileDropdown = () => {
        const dropdown = document.getElementById("profile-dropdown-menu");
        if (dropdown) dropdown.classList.remove("dropdown-visible");
      };

      document.addEventListener("click", () => {
        window.closeProfileDropdown();
      });

      window.handleImageError = (img) => {
        img.onerror = null;
        img.src = "https://placehold.co/300x200?text=No+Image";
        img.onclick = null; // Disable click if error
        img.style.cursor = "default";
      };

      window.formatGoogleDriveLink = (url) => {
        if (!url) return "";
        const idMatch = url.match(/[-\w]{25,}/);
        if (
          idMatch &&
          (url.includes("drive.google.com") || url.includes("docs.google.com"))
        ) {
          return `https://drive.google.com/thumbnail?id=${idMatch[0]}&sz=w800`;
        }
        return url;
      };

      // Helper function for global loading
      window.showLoading = (text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...") => {
        Swal.fire({
          title: text,
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
      };

      window.hideLoading = () => {
        Swal.close();
      };

      // Set to track selected logs for deletion
      window.selectedLogIds = new Set();

      // Temp storage for modal tags
      window.tempTags = [];

      // Network Status Listeners
      window.addEventListener("offline", () => {
        Swal.fire({
          icon: "warning",
          title: "‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï",
          text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 5000,
          timerProgressBar: true,
          background: "#fff",
          iconColor: "#f59e0b",
        });
      });

      window.addEventListener("online", () => {
        Swal.fire({
          icon: "success",
          title: "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß",
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true,
        });
      });
    </script>

    <!-- Image Lightbox Modal -->
    <div
      id="image-modal"
      class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center cursor-zoom-out p-4"
      onclick="closeImageModal()"
    >
      <div class="relative max-w-full max-h-full">
        <img
          id="image-modal-content"
          src=""
          class="max-h-[90vh] max-w-full object-contain rounded-lg shadow-2xl transition-transform duration-300 transform scale-95"
          onclick="event.stopPropagation()"
        />
        <button
          class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300 focus:outline-none"
          onclick="closeImageModal()"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div
      id="saving-indicator"
      class="fixed bottom-4 right-4 z-[60] bg-white dark:bg-dark-card shadow-lg rounded-full px-4 py-2 text-xs font-medium text-gray-500 hidden flex items-center gap-2 border border-gray-100 dark:border-gray-700"
    >
      <i class="fas fa-circle-notch fa-spin text-primary-500"></i>
      <span id="saving-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
    </div>

    <div
      id="login-screen"
      class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-primary-600 to-blue-800 p-4 hidden"
    >
      <div
        class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all fade-in"
      >
        <div class="text-center mb-8">
          <div
            class="bg-primary-100 dark:bg-primary-900 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-primary-600 dark:text-primary-300 shadow-inner"
          >
            <i class="fas fa-toolbox text-3xl"></i>
          </div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
            ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å-‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
          </h1>
          <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">
            Equipment Management System
          </p>
        </div>
        <form id="login-form" class="space-y-5">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
              >‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label
            >
            <div class="relative">
              <i
                class="fas fa-id-card absolute left-3 top-3.5 text-gray-400"
              ></i>
              <input
                type="text"
                id="login-id"
                required
                class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none transition"
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
              />
            </div>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
              >‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label
            >
            <div class="relative">
              <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
              <input
                type="text"
                id="login-name"
                required
                class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none transition"
                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
              />
            </div>
          </div>

          <button
            type="submit"
            class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3.5 rounded-lg shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2"
          >
            <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </form>
      </div>
    </div>

    <div id="app-screen" class="hidden flex flex-col min-h-screen">
      <nav
        class="sticky top-0 z-40 glass border-b border-gray-200 dark:border-gray-700 shadow-sm"
      >
        <div class="w-full px-4">
          <div class="flex justify-between h-16">
            <div class="flex items-center gap-3">
              <div
                class="bg-primary-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md"
              >
                <i class="fas fa-wrench text-sm"></i>
              </div>
              <div class="flex flex-col justify-center">
                <span class="font-bold text-lg leading-tight tracking-tight"
                  >Tools<span class="text-primary-600 dark:text-primary-400"
                    >Master</span
                  ></span
                >
                <div class="flex items-center gap-2">
                  <div
                    class="flex items-center gap-1 text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wide"
                  >
                    <span>Borrow Systems</span>
                  </div>
                  <span
                    class="w-2 h-2 rounded-full bg-green-500 animate-pulse mr-1"
                    title="Online"
                  ></span>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button
                onclick="toggleTheme()"
                class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 hover:text-orange-500 dark:hover:text-yellow-400 transition flex items-center justify-center border border-gray-200 dark:border-gray-600"
              >
                <i class="fas fa-moon dark:hidden"></i
                ><i class="fas fa-sun hidden dark:block"></i>
              </button>
              <div class="relative group z-50">
                <button
                  onclick="toggleProfileDropdown(event)"
                  class="flex items-center gap-2 pl-2"
                >
                  <div class="text-right hidden sm:block">
                    <p
                      id="user-display-name"
                      class="text-sm font-semibold text-gray-900 dark:text-white truncate max-w-[120px]"
                    >
                      User
                    </p>
                    <p
                      id="user-display-role"
                      class="text-xs text-gray-500 dark:text-gray-400"
                    >
                      Staff
                    </p>
                  </div>
                  <!-- UPDATED: User Icon Container with ID for Color Control -->
                  <div
                    id="user-role-icon-bg"
                    class="w-9 h-9 rounded-full bg-primary-100 dark:bg-primary-900 border-2 border-white dark:border-gray-600 flex items-center justify-center text-primary-600 dark:text-primary-300"
                  >
                    <i class="fas fa-user text-sm"></i>
                  </div>
                </button>
                <div
                  id="profile-dropdown-menu"
                  class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl py-2 invisible opacity-0 transition-all transform origin-top-right border border-gray-100 dark:border-gray-700"
                >
                  <div
                    class="px-4 py-2 border-b border-gray-100 dark:border-gray-700 sm:hidden"
                  >
                    <p
                      class="text-sm font-bold text-gray-900 dark:text-white"
                      id="mobile-user-name"
                    >
                      User
                    </p>
                    <p class="text-xs text-gray-500" id="mobile-user-role">
                      Staff
                    </p>
                  </div>
                  <button
                    onclick="
                      DataService.loadData();
                      closeProfileDropdown();
                    "
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
                  >
                    <i class="fas fa-sync-alt mr-2 text-blue-500"></i>
                    ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                  </button>
                  <!-- ADDED: History Menu for Users -->
                  <button
                    onclick="
                      switchTab('history');
                      closeProfileDropdown();
                    "
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border-t border-gray-100 dark:border-gray-700"
                  >
                    <i class="fas fa-history mr-2 text-primary-500"></i>
                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô
                  </button>
                  <button
                    onclick="logout()"
                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"
                  >
                    <i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <!-- Updated Nav Container: Removed overflow-x-hidden to allow dropdown to show -->
      <div
        class="bg-white dark:bg-dark-card shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-16 z-30"
      >
        <div class="w-full px-2 sm:px-4">
          <!-- Compact Nav for Mobile -->
          <div class="flex items-center justify-between py-2">
            <div
              class="flex flex-1 gap-1 sm:gap-2 justify-between sm:justify-start"
            >
              <button
                onclick="switchTab('inventory')"
                id="tab-inventory"
                class="tab-btn active-tab flex-1 sm:flex-none px-2 sm:px-4 py-2 rounded-lg sm:rounded-full text-[10px] sm:text-sm font-medium flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 transition-all"
              >
                <i class="fas fa-box-open text-base sm:text-sm"></i>
                <span>‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á</span>
              </button>
              <button
                onclick="switchTab('my-items')"
                id="tab-my-items"
                class="tab-btn flex-1 sm:flex-none px-2 sm:px-4 py-2 rounded-lg sm:rounded-full text-[10px] sm:text-sm font-medium flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 transition-all relative"
              >
                <i class="fas fa-hand-holding text-base sm:text-sm"></i>
                <span>‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                <span
                  id="my-items-badge"
                  class="hidden absolute top-0 right-0 sm:-top-1 sm:-right-1 w-4 h-4 sm:w-5 sm:h-5 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800"
                  >0</span
                >
              </button>
              <!-- UPDATED: Verify Tab (Default Gray) -->
              <button
                onclick="switchTab('verify')"
                id="tab-verify"
                class="tab-btn hidden flex-1 sm:flex-none px-2 sm:px-4 py-2 rounded-lg sm:rounded-full text-[10px] sm:text-sm font-medium flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 transition-all relative text-gray-500 dark:text-gray-400"
              >
                <i class="fas fa-tasks text-base sm:text-sm"></i>
                <span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                <span
                  id="verify-badge"
                  class="hidden absolute top-0 right-0 sm:-top-1 sm:-right-1 w-4 h-4 sm:w-5 sm:h-5 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800"
                  >0</span
                >
              </button>
              <!-- History Tab: Hidden by default for Users, Shown for Admins via JS -->
              <button
                onclick="switchTab('history')"
                id="tab-history"
                class="tab-btn flex-1 sm:flex-none px-2 sm:px-4 py-2 rounded-lg sm:rounded-full text-[10px] sm:text-sm font-medium flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 transition-all hidden"
              >
                <i class="fas fa-history text-base sm:text-sm"></i>
                <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
              </button>

              <!-- UPDATED: Admin Dropdown Trigger (Default Gray) -->
              <div class="relative hidden" id="admin-menu-container">
                <button
                  onclick="
                    document
                      .getElementById('admin-dropdown')
                      .classList.toggle('hidden')
                  "
                  id="tab-admin-group"
                  class="tab-btn flex-1 sm:flex-none px-2 sm:px-4 py-2 rounded-lg sm:rounded-full text-[10px] sm:text-sm font-medium flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 transition-all text-gray-500 dark:text-gray-400"
                >
                  <i class="fas fa-user-shield text-base sm:text-sm"></i>
                  <span
                    >Admin <i class="fas fa-chevron-down text-[8px] ml-1"></i
                  ></span>
                </button>
                <!-- Dropdown Content - Increased z-index to 60 -->
                <div
                  id="admin-dropdown"
                  class="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 hidden z-[60] overflow-hidden ring-1 ring-black ring-opacity-5"
                >
                  <button
                    onclick="
                      switchTab('dashboard');
                      document
                        .getElementById('admin-dropdown')
                        .classList.add('hidden');
                    "
                    class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2 border-b border-gray-50 dark:border-gray-700 text-gray-700 dark:text-gray-300"
                  >
                    <i
                      class="fas fa-chart-pie w-5 text-center text-indigo-500"
                    ></i>
                    ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                  </button>
                  <button
                    onclick="
                      switchTab('admin');
                      document
                        .getElementById('admin-dropdown')
                        .classList.add('hidden');
                    "
                    class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2 border-b border-gray-50 dark:border-gray-700 text-gray-700 dark:text-gray-300"
                  >
                    <i class="fas fa-cog w-5 text-center text-purple-500"></i>
                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å
                  </button>
                  <button
                    onclick="
                      switchTab('users');
                      document
                        .getElementById('admin-dropdown')
                        .classList.add('hidden');
                    "
                    class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2 text-gray-700 dark:text-gray-300"
                    id="btn-menu-users"
                  >
                    <i
                      class="fas fa-users-cog w-5 text-center text-pink-500"
                    ></i>
                    ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <main class="flex-1 w-full px-4 py-6 pb-24">
        <!-- Dashboard View -->
        <div id="view-dashboard" class="hidden fade-in">
          <!-- Content same as before -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
              <h2 class="text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-chart-line text-indigo-500"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
                (Dashboard)
              </h2>
              <button
                onclick="refreshDashboardData()"
                class="bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-600 px-4 py-2 rounded-lg text-sm shadow-sm transition flex items-center gap-2"
              >
                <i class="fas fa-sync-alt text-indigo-500"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-blue-500"
              >
                <div class="text-xs text-gray-500 dark:text-dark-muted">
                  ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
                </div>
                <div class="text-2xl font-bold" id="stat-total-items">0</div>
              </div>
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-green-500"
              >
                <div class="text-xs text-gray-500 dark:text-dark-muted">
                  ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (Logs)
                </div>
                <div class="text-2xl font-bold" id="stat-total-logs">-</div>
              </div>
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-yellow-500"
              >
                <div class="text-xs text-gray-500 dark:text-dark-muted">
                  ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°
                </div>
                <div class="text-2xl font-bold" id="stat-active-borrows">0</div>
              </div>
              <div
                class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-indigo-500"
              >
                <div class="text-xs text-gray-500 dark:text-dark-muted">
                  ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </div>
                <div class="text-2xl font-bold" id="stat-users-count">-</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm">
                <h3
                  class="font-bold mb-4 text-sm text-gray-700 dark:text-gray-300"
                >
                  üèÜ ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 5)
                </h3>
                <div class="relative h-64">
                  <canvas id="chart-users"></canvas>
                </div>
              </div>

              <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm">
                <h3
                  class="font-bold mb-4 text-sm text-gray-700 dark:text-gray-300"
                >
                  üì¶ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï (Top 5)
                </h3>
                <div class="relative h-64">
                  <canvas id="chart-items"></canvas>
                </div>
              </div>
            </div>

            <div
              class="mt-6 bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden"
            >
              <div
                class="px-6 py-4 border-b border-gray-100 dark:border-gray-700"
              >
                <h3 class="font-bold text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
              </div>
              <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h4
                    class="text-green-600 dark:text-green-400 font-bold text-xs uppercase mb-2"
                  >
                    üî• ‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                  </h4>
                  <ul id="list-most-borrowed" class="space-y-2 text-sm"></ul>
                </div>
                <div>
                  <h4
                    class="text-red-500 dark:text-red-400 font-bold text-xs uppercase mb-2"
                  >
                    ‚ùÑÔ∏è ‡∏¢‡∏∑‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Zero Use)
                  </h4>
                  <ul
                    id="list-least-borrowed"
                    class="space-y-2 text-sm text-gray-500 dark:text-dark-muted"
                  ></ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="view-inventory" class="fade-in">
          <div
            class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
          >
            <h2
              class="text-xl font-bold flex items-center gap-2 whitespace-nowrap"
            >
              <i class="fas fa-search text-primary-500"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </h2>
            <div class="flex w-full md:w-auto gap-2">
              <div class="relative w-2/5 md:w-48">
                <select
                  id="filter-category"
                  class="w-full appearance-none pl-4 pr-8 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-primary-500 outline-none shadow-sm cursor-pointer"
                >
                  <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                </select>
                <i
                  class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 pointer-events-none text-xs"
                ></i>
              </div>
              <div class="relative w-2/3 md:w-64">
                <input
                  type="text"
                  id="search-inventory"
                  placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..."
                  class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-primary-500 outline-none shadow-sm text-sm"
                />
                <i
                  class="fas fa-search absolute left-3 top-3.5 text-gray-400"
                ></i>
              </div>
            </div>
          </div>
          <!-- ADDED: Active Filter Display with Clear Button -->
          <div id="active-filter-display" class="hidden mb-4 animate-fade-in">
            <!-- Injected via JS -->
          </div>
          <div
            id="inventory-grid"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 sm:gap-6"
          ></div>
        </div>

        <div id="view-my-items" class="hidden fade-in">
          <!-- My Items Content -->
          <div class="flex justify-between items-end mb-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏∑‡∏°
              </h2>
              <p class="text-sm text-gray-500 dark:text-dark-muted">
                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
              </p>
            </div>
            <div class="flex gap-2">
              <button
                onclick="returnAllItems()"
                id="btn-return-all"
                class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm shadow-md transition flex items-center gap-2"
              >
                <i class="fas fa-undo-alt"></i> ‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </button>
            </div>
          </div>
          <div class="mb-6">
            <h3
              class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200 border-l-4 border-primary-500 pl-3"
            >
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏° (Active)
            </h3>
            <div
              id="my-items-active-list"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            ></div>
            <div
              id="my-items-active-empty"
              class="hidden text-center py-6 text-gray-400 dark:text-dark-muted text-sm bg-gray-50 dark:bg-gray-800 rounded-xl"
            >
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°
            </div>
          </div>
          <div>
            <h3
              class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200 border-l-4 border-yellow-500 pl-3"
            >
              ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Pending Confirmation)
            </h3>
            <div
              id="my-items-pending-list"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            ></div>
            <div
              id="my-items-pending-empty"
              class="hidden text-center py-6 text-gray-400 dark:text-dark-muted text-sm bg-gray-50 dark:bg-gray-800 rounded-xl"
            >
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </div>
          </div>
        </div>

        <div id="view-verify" class="hidden fade-in">
          <!-- Verify Content -->
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á</h2>
            <button
              onclick="verifyAllReturns()"
              id="btn-verify-all"
              class="hidden bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm shadow-md transition flex items-center gap-2"
            >
              <i class="fas fa-check-double"></i> ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
          <div
            id="verify-list"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
          ></div>
          <div
            id="verify-empty"
            class="hidden text-center py-12 bg-white dark:bg-dark-card rounded-xl border border-dashed border-gray-300 dark:border-gray-700"
          >
            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
          </div>
        </div>

        <div id="view-history" class="hidden fade-in">
          <!-- History Content -->
          <div
            class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
          >
            <h2 class="text-xl font-bold whitespace-nowrap">
              ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô
            </h2>

            <div class="flex w-full md:w-auto gap-2 items-center">
              <div class="relative w-full md:w-auto">
                <!-- Changed from type="date" to type="text" for Flatpickr -->
                <input
                  type="text"
                  id="history-date-picker"
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 dark:text-white shadow-sm focus:ring-2 focus:ring-primary-500 outline-none text-sm"
                  placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..."
                />
              </div>
              <button
                onclick="searchHistoryByDate()"
                class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg shadow-sm text-sm whitespace-nowrap flex items-center gap-2"
              >
                <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>
          </div>

          <!-- History Action Area -->
          <div
            id="history-action-area"
            class="hidden items-center gap-2 mb-4 justify-end"
          >
            <button
              onclick="toggleSelectAllMobile()"
              class="text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1.5 rounded-lg text-gray-600 dark:text-gray-300 transition flex items-center gap-1"
            >
              <i class="fas fa-check-double text-xs"></i>
              <span id="select-all-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            </button>

            <span
              id="selection-count"
              class="text-xs text-gray-500 dark:text-dark-muted hidden sm:inline"
              >0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span
            >

            <button
              onclick="deleteSelectedLogs()"
              id="btn-bulk-delete"
              class="bg-red-100 hover:bg-red-200 text-red-600 dark:bg-red-900/50 dark:hover:bg-red-900/70 dark:text-red-300 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1"
            >
              <i class="fas fa-trash-alt text-xs"></i> ‡∏•‡∏ö
            </button>
          </div>

          <!-- History Container (Supports both Table and Card view via JS injection) -->
          <div id="history-container" class="min-h-[200px]">
            <!-- Default Empty State -->
            <div
              class="text-center py-12 bg-white dark:bg-dark-card rounded-xl border border-dashed border-gray-300 dark:border-gray-700"
            >
              <i
                class="fas fa-calendar-day text-4xl text-gray-300 dark:text-gray-600 mb-3"
              ></i>
              <p class="text-gray-500 dark:text-gray-400">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
              </p>
            </div>
          </div>
        </div>

        <div id="view-admin" class="hidden fade-in">
          <!-- Admin Content -->
          <div
            class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
          >
            <h2 class="text-xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
            <div class="flex gap-2 w-full md:w-auto">
              <!-- ADDED: Admin Filter -->
              <div class="relative flex-1 md:w-48">
                <select
                  id="admin-filter-category"
                  class="w-full appearance-none pl-4 pr-8 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-primary-500 outline-none shadow-sm cursor-pointer h-full"
                >
                  <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                </select>
                <i
                  class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none text-xs"
                ></i>
              </div>

              <button
                onclick="openAddModal()"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow text-sm whitespace-nowrap"
              >
                <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
              </button>
            </div>
          </div>

          <!-- Admin Inventory Container (Supports both Table and Card view via JS injection) -->
          <div id="admin-inventory-container">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Users View -->
        <div id="view-users" class="hidden fade-in">
          <h2 class="text-xl font-bold mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>

          <!-- Users Container (Supports both Table and Card view via JS injection) -->
          <div id="users-container">
            <!-- Will be populated by JS -->
          </div>
        </div>
      </main>
    </div>

    <!-- Borrow Modal -->
    <div
      id="borrow-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm p-4"
    >
      <div
        class="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl shadow-2xl p-6"
      >
        <div class="flex gap-4 mb-4">
          <img
            id="borrow-img-preview"
            src=""
            referrerpolicy="no-referrer"
            class="w-20 h-20 rounded-lg object-cover bg-gray-100 cursor-pointer hover:opacity-80 transition"
            onclick="openImageModal(this.src)"
            onerror="handleImageError(this)"
          />
          <div>
            <h3
              class="text-lg font-bold text-gray-900 dark:text-white leading-tight mb-1"
              id="borrow-item-name"
            ></h3>
            <p class="text-xs text-gray-500 dark:text-dark-muted">
              ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:
              <span
                id="borrow-item-max"
                class="font-bold text-primary-600 text-base"
              ></span>
            </p>
          </div>
        </div>
        <div class="flex items-center justify-center gap-4 mb-6">
          <button
            onclick="adjustQty(-1)"
            class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700"
          >
            <i class="fas fa-minus"></i>
          </button>
          <input
            type="number"
            id="borrow-qty"
            min="1"
            value="1"
            readonly
            class="w-16 text-center text-2xl font-bold bg-transparent outline-none no-spinner"
          />
          <button
            onclick="adjustQty(1)"
            class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700"
          >
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button
            onclick="closeModal('borrow-modal')"
            class="py-3 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-500"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button
            id="btn-confirm-borrow"
            onclick="confirmBorrow()"
            class="py-3 rounded-xl bg-primary-600 text-white font-bold shadow-lg"
          >
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Item Modal -->
    <div
      id="item-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm p-4"
    >
      <div
        class="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-2xl p-6 overflow-y-auto max-h-[90vh]"
      >
        <h3 id="item-modal-title" class="text-lg font-bold mb-4">
          ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        </h3>
        <form id="item-form" class="space-y-4">
          <input type="hidden" id="item-id" />

          <div>
            <label class="block text-sm mb-2 font-medium">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
            <div class="flex flex-col sm:flex-row gap-2 mb-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="img-source"
                  value="file"
                  checked
                  class="text-primary-600"
                  onchange="toggleImageSource('file')"
                />
                <span class="text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="img-source"
                  value="url"
                  class="text-primary-600"
                  onchange="toggleImageSource('url')"
                />
                <span class="text-sm">‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</span>
              </label>
            </div>

            <div
              class="flex items-start gap-4 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800"
            >
              <div
                class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden border flex-shrink-0 relative group"
              >
                <img
                  id="item-image-preview"
                  src="https://placehold.co/100?text=Preview"
                  referrerpolicy="no-referrer"
                  class="w-full h-full object-cover"
                  onerror="handleImageError(this)"
                />
                <div
                  id="upload-loading-spinner"
                  class="absolute inset-0 bg-black/50 flex items-center justify-center hidden"
                >
                  <i class="fas fa-circle-notch fa-spin text-white"></i>
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div id="input-type-file">
                  <label
                    class="cursor-pointer bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-600 transition shadow-sm w-full justify-center"
                  >
                    <i class="fas fa-camera"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    <input
                      type="file"
                      id="item-image-file"
                      accept="image/*"
                      class="hidden"
                    />
                  </label>
                  <p class="text-xs text-gray-400 mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG</p>
                </div>
                <div id="input-type-url" class="hidden">
                  <input
                    type="url"
                    id="item-image-url"
                    placeholder="https://example.com/image.jpg"
                    class="w-full px-3 py-2 text-sm border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 outline-none"
                  />
                  <p class="text-xs text-gray-400 mt-2">
                    ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô
                  </p>
                </div>
                <!-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Base64 ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á GAS -->
                <input type="hidden" id="item-image-temp-base64" />
              </div>
            </div>
          </div>

          <input
            type="text"
            id="item-name"
            required
            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700"
          />

          <!-- MULTI-TAG INPUT SECTION (FIXED LAYOUT) -->
          <div class="mb-2">
            <label class="block text-sm mb-1 font-medium"
              >‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Tags)</label
            >
            <div
              class="flex flex-wrap gap-2 mb-2 p-2 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 min-h-[42px]"
              id="modal-tags-container"
            >
              <!-- Tags will be injected here -->
            </div>
            <div class="flex flex-row gap-2">
              <div class="flex-1 relative">
                <input
                  type="text"
                  id="item-tag-input"
                  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°"
                  list="category-list"
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700"
                  onkeypress="
                    if (event.key === 'Enter') {
                      event.preventDefault();
                      addTagFromInput();
                    }
                  "
                />
                <datalist id="category-list"></datalist>
              </div>
              <button
                type="button"
                onclick="addTagFromInput()"
                class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg whitespace-nowrap"
              >
                ‡πÄ‡∏û‡∏¥‡πà‡∏°
              </button>
            </div>
          </div>

          <input
            type="number"
            id="item-stock"
            min="1"
            required
            placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Stock"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700"
          />

          <div class="flex justify-end gap-3 pt-4">
            <button
              type="button"
              onclick="closeModal('item-modal')"
              class="px-4 py-2 text-gray-500"
            >
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-primary-600 text-white rounded-lg shadow"
            >
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDocs,
        getDoc,
        setDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        query,
        where,
        runTransaction,
        writeBatch,
        orderBy,
        limit,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      // --- FIREBASE CONFIGURATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyCqP4PJZjifXa96NLdJ5Dd9A9AWLYcIiqs",
        authDomain: "borrow-tools-system.firebaseapp.com",
        projectId: "borrow-tools-system",
        storageBucket: "borrow-tools-system.firebasestorage.app",
        messagingSenderId: "1027262105690",
        appId: "1:1027262105690:web:0db3c601e67ef04a303063",
      };

      // Initialize Firebase
      let app, db;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("Firebase Connected");
      } catch (e) {
        console.error("Firebase Init Error:", e);
      }

      // --- GLOBAL STATE ---
      window.currentUser = null;
      window.inventoryData = [];

      // Updated Data Structure for Quota Management
      window.activeLogs = []; // For My Items & Verify (Fetched on Init/Update)
      window.historyLogs = []; // For History View (Fetched on Demand)
      window.cachedAllLogs = []; // For Dashboard Stats (Fetched on Refresh)

      window.usersData = [];
      window.currentBorrowItemId = null;
      let isSaving = false;
      let unsubscribeInventory = null;
      let unsubscribeUsers = null;
      let unsubscribeActiveLogs = null; // ADDED: Global listener variable

      // --- HELPER & UI FUNCTIONS (HOISTED) ---

      // UPDATED: Create responsive Marquee (Mobile Only)
      window.createMarqueeHtml = (text, maxLength = 18) => {
        if (text.length <= maxLength) {
          return `<h4 class="font-bold text-gray-900 dark:text-gray-100 truncate leading-tight">${text}</h4>`;
        }
        return `
            <div class="marquee-wrapper w-full md:hidden">
                <div class="marquee-content">
                    <span class="font-bold text-gray-900 dark:text-gray-100 mr-8">${text}</span>
                    <span class="font-bold text-gray-900 dark:text-gray-100 mr-8">${text}</span>
                </div>
            </div>
            <h4 class="hidden md:block font-bold text-gray-900 dark:text-gray-100 truncate leading-tight" title="${text}">${text}</h4>
          `;
      };

      window.getCategoryArray = (item) => {
        if (!item.category) return [];
        if (Array.isArray(item.category)) return item.category;
        return [item.category]; // Legacy support for string
      };

      window.getTagColor = (tag) => {
        if (!tag)
          return "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300";

        const colors = [
          "bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-200",
          "bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-200",
          "bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-200",
          "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200",
          "bg-lime-100 text-lime-800 dark:bg-lime-900/50 dark:text-lime-200",
          "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200",
          "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-200",
          "bg-teal-100 text-teal-800 dark:bg-teal-900/50 dark:text-teal-200",
          "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/50 dark:text-cyan-200",
          "bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-200",
          "bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200",
          "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-200",
          "bg-violet-100 text-violet-800 dark:bg-violet-900/50 dark:text-violet-200",
          "bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-200",
          "bg-fuchsia-100 text-fuchsia-800 dark:bg-fuchsia-900/50 dark:text-fuchsia-200",
          "bg-pink-100 text-pink-800 dark:bg-pink-900/50 dark:text-pink-200",
          "bg-rose-100 text-rose-800 dark:bg-rose-900/50 dark:text-rose-200",
        ];

        let hash = 0;
        for (let i = 0; i < tag.length; i++) {
          hash = tag.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash % colors.length);
        return colors[index];
      };

      window.renderTagsInModal = () => {
        const container = document.getElementById("modal-tags-container");
        container.innerHTML = "";
        window.tempTags.forEach((tag, index) => {
          const colorClass = window.getTagColor(tag);
          const span = document.createElement("span");
          span.className = `${colorClass} px-2 py-1 rounded-lg text-sm flex items-center gap-1 shadow-sm border border-transparent dark:border-white/10`;
          span.innerHTML = `${tag} <button type="button" onclick="removeTag(${index})" class="opacity-60 hover:opacity-100 font-bold ml-1">&times;</button>`;
          container.appendChild(span);
        });
      };

      window.addTagFromInput = () => {
        const input = document.getElementById("item-tag-input");
        const val = input.value.trim();
        if (val && !window.tempTags.includes(val)) {
          window.tempTags.push(val);
          renderTagsInModal();
          input.value = "";
        }
      };

      window.removeTag = (index) => {
        window.tempTags.splice(index, 1);
        renderTagsInModal();
      };

      // Global filter by clicking tag
      window.filterByTag = (tag) => {
        // Set inventory filter
        const select = document.getElementById("filter-category");
        select.value = tag;
        switchTab("inventory");
        renderInventory();
        // Also set Admin filter for consistency
        const adminSelect = document.getElementById("admin-filter-category");
        if (adminSelect) adminSelect.value = tag;
      };

      window.clearFilter = () => {
        const select = document.getElementById("filter-category");
        select.value = "";
        const adminSelect = document.getElementById("admin-filter-category");
        if (adminSelect) adminSelect.value = "";
        renderInventory();
        if (
          document.getElementById("view-admin").classList.contains("hidden") ===
          false
        ) {
          if (typeof renderAdminTable === "function") renderAdminTable();
        }
      };

      function switchTab(tab) {
        // Scroll to top
        window.scrollTo(0, 0);
        window.closeProfileDropdown();

        document.querySelectorAll(".tab-btn").forEach((b) => {
          b.classList.remove(
            "active-tab",
            "bg-primary-50",
            "text-primary-600",
            "dark:bg-primary-900/50",
            "dark:text-primary-300",
            "bg-yellow-50",
            "text-yellow-600",
            "dark:bg-yellow-900/50",
            "dark:text-yellow-300",
            "bg-indigo-50",
            "text-indigo-600",
            "dark:bg-indigo-900/50",
            "dark:text-indigo-300",
            "bg-purple-50",
            "text-purple-600",
            "dark:bg-purple-900/50",
            "dark:text-purple-300",
            "bg-pink-50",
            "text-pink-600",
            "dark:bg-pink-900/50",
            "dark:text-pink-300",
          );

          b.classList.add("text-gray-500", "dark:text-gray-400");
        });

        const adminDropdown = document.getElementById("admin-dropdown");
        if (adminDropdown) adminDropdown.classList.add("hidden");

        let btn;
        if (["dashboard", "admin", "users"].includes(tab)) {
          btn = document.getElementById("tab-admin-group");
        } else {
          btn = document.getElementById(`tab-${tab}`);
        }

        if (btn) {
          btn.classList.remove("text-gray-500", "dark:text-gray-400");

          if (tab === "verify") {
            btn.classList.add(
              "active-tab",
              "bg-yellow-50",
              "text-yellow-600",
              "dark:bg-yellow-900/50",
              "dark:text-yellow-300",
            );
          } else if (["dashboard", "admin", "users"].includes(tab)) {
            btn.classList.add(
              "active-tab",
              "bg-purple-50",
              "text-purple-600",
              "dark:bg-purple-900/50",
              "dark:text-purple-300",
            );
          } else {
            btn.classList.add(
              "active-tab",
              "bg-primary-50",
              "text-primary-600",
              "dark:bg-primary-900/50",
              "dark:text-primary-300",
            );
          }
        }

        [
          "inventory",
          "my-items",
          "verify",
          "history",
          "admin",
          "dashboard",
          "users",
        ].forEach((v) => {
          const el = document.getElementById(`view-${v}`);
          if (el) el.classList.toggle("hidden", v !== tab);
        });

        if (tab === "users" && typeof renderUsers === "function") renderUsers();
        if (tab === "my-items" && typeof renderMyItems === "function")
          renderMyItems();
        // Updated: History does not auto-render, needs search
        if (tab === "history") {
          // Optional: Set default date to today but don't auto-fetch to save quota
          const today = new Date().toISOString().split("T")[0];
          // Initialize Flatpickr if not already done
          if (!window.historyFlatpickr) {
            window.historyFlatpickr = flatpickr("#history-date-picker", {
              dateFormat: "Y-m-d",
              altInput: true,
              altFormat: "d/m/Y",
              defaultDate: today,
              allowInput: false,
              disableMobile: true, // FIX: Forces Flatpickr UI on mobile instead of native picker
            });
          } else {
            window.historyFlatpickr.setDate(today);
          }
        }
        if (tab === "verify" && typeof renderVerify === "function")
          renderVerify();
        if (tab === "dashboard" && typeof renderDashboard === "function")
          renderDashboard();
        if (tab === "admin" && typeof renderAdminTable === "function")
          renderAdminTable();
      }

      function toggleTheme() {
        const html = document.documentElement;
        if (html.classList.contains("dark")) {
          html.classList.remove("dark");
          localStorage.setItem(APP_CONFIG.storageKeys.theme, "light");
        } else {
          html.classList.add("dark");
          localStorage.setItem(APP_CONFIG.storageKeys.theme, "dark");
        }
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      function openImageModal(src) {
        if (!src || src.includes("placehold.co")) return;
        const modal = document.getElementById("image-modal");
        const img = document.getElementById("image-modal-content");
        img.src = src;
        modal.classList.remove("hidden");
        setTimeout(() => {
          img.classList.remove("scale-95");
        }, 10);
      }

      function closeImageModal() {
        const modal = document.getElementById("image-modal");
        const img = document.getElementById("image-modal-content");
        img.classList.add("scale-95");
        setTimeout(() => {
          modal.classList.add("hidden");
          img.src = "";
        }, 200);
      }

      function adjustQty(n) {
        const el = document.getElementById("borrow-qty");
        let v = parseInt(el.value) + n;
        let max = parseInt(el.max || 1);
        if (v < 1) v = 1;
        if (v > max) v = max;
        el.value = v;
      }

      // --- EXPORT GLOBAL FUNCTIONS ---
      window.switchTab = switchTab;
      window.toggleTheme = toggleTheme;
      window.closeModal = closeModal;
      window.openImageModal = openImageModal;
      window.closeImageModal = closeImageModal;
      window.adjustQty = adjustQty;

      window.DataService = {
        loadData: () => {
          window.location.reload();
        },
        saveData: async () => true,
      };

      // --- REALTIME LISTENERS ---
      function startRealtimeListeners() {
        // Inventory Listener (Kept for Stock updates)
        if (unsubscribeInventory) unsubscribeInventory();
        unsubscribeInventory = onSnapshot(
          collection(db, "inventory"),
          (snapshot) => {
            window.inventoryData = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            renderInventory();
            populateCategories();
            if (
              window.currentUser &&
              (window.currentUser.role === "admin" ||
                window.currentUser.role === "assistant")
            ) {
              if (typeof renderAdminTable === "function") renderAdminTable();
              // Removed auto renderDashboard to save quota/performance
            }
          },
        );

        // ADDED: Real-time listener for active logs (borrowed & pending_return)
        // This makes "Verify" page for admin real-time with minimum quota usage
        if (unsubscribeActiveLogs) unsubscribeActiveLogs();
        const qLogs = query(
          collection(db, "logs"),
          where("status", "in", ["borrowed", "pending_return"]),
        );
        unsubscribeActiveLogs = onSnapshot(
          qLogs,
          (snapshot) => {
            window.activeLogs = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            // Re-render components that use this data
            if (
              document
                .getElementById("view-my-items")
                .classList.contains("hidden") === false
            )
              renderMyItems();
            if (
              document
                .getElementById("view-verify")
                .classList.contains("hidden") === false
            )
              renderVerify();

            // Always update badges
            renderMyItems();
            renderVerify();
          },
          (err) => {
            console.error("Logs Listener Error:", err);
          },
        );

        // Users Listener (Admin Only)
        if (window.currentUser.role === "admin") {
          if (unsubscribeUsers) unsubscribeUsers();
          unsubscribeUsers = onSnapshot(collection(db, "users"), (snapshot) => {
            window.usersData = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            if (typeof renderUsers === "function") renderUsers();
          });
        }
      }

      // --- DATA FETCHING FUNCTIONS (MANUAL) ---

      // UPDATED: Now mostly redundant but kept for logic consistency where called
      window.fetchActiveLogs = async () => {
        // Data is now handled by the real-time listener in startRealtimeListeners
        // But we return the current array for compatibility
        return window.activeLogs;
      };

      window.searchHistoryByDate = async () => {
        const datePicker = document.getElementById("history-date-picker");
        const selectedDate = datePicker.value;

        if (!selectedDate) {
          Swal.fire({
            icon: "warning",
            title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,
          });
          return;
        }

        window.showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

        try {
          // Construct Date Range for the selected day
          // ISO format is YYYY-MM-DDTHH:mm:ss.sssZ
          // We want >= selectedDate and < selectedDate + 1 day
          const startDateStr = selectedDate;
          const nextDate = new Date(selectedDate);
          nextDate.setDate(nextDate.getDate() + 1);
          const endDateStr = nextDate.toISOString().split("T")[0];

          // --- FIX: QUERY BY DATE ONLY TO AVOID COMPOSITE INDEX ERROR ---
          // Firestore requires an index if you combine Equality (empId) with Inequality (borrowDate).
          // Since the user cannot create an index easily, we query ONLY by Date Range (which works by default).
          // Then we filter by empId in JavaScript memory.
          // This also saves quota compared to fetching ALL user history, as daily logs are usually fewer than lifetime logs.

          const q = query(
            collection(db, "logs"),
            where("borrowDate", ">=", startDateStr),
            where("borrowDate", "<", endDateStr),
          );

          const snapshot = await getDocs(q);

          // 1. Convert to Array
          let logs = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // 2. Filter Client-Side for Regular Users
          const canSeeAll =
            window.currentUser.role === "admin" ||
            window.currentUser.role === "assistant";
          if (!canSeeAll) {
            logs = logs.filter((log) => log.empId === window.currentUser.empId);
          }

          if (logs.length === 0) {
            window.hideLoading();
            window.historyLogs = [];
            renderHistory();

            // Toast Alert
            Swal.fire({
              icon: "info",
              title: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
              text: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å",
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 3000,
            });
          } else {
            window.historyLogs = logs;
            // Sort locally by date desc
            window.historyLogs.sort(
              (a, b) => new Date(b.borrowDate) - new Date(a.borrowDate),
            );

            window.hideLoading();
            renderHistory();

            Swal.fire({
              icon: "success",
              title: `‡∏û‡∏ö ${window.historyLogs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 1500,
            });
          }
        } catch (e) {
          console.error(e);
          window.hideLoading();
          Swal.fire("Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: " + e.message, "error");
        }
      };

      window.refreshDashboardData = async () => {
        const result = await Swal.fire({
          title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï?",
          text: "‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï",
          cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
        });

        if (result.isConfirmed) {
          window.showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...");
          try {
            // 1. Refresh Active Logs (for integrity)
            await window.fetchActiveLogs();

            // 2. Fetch ALL logs for statistics (Heavy Operation)
            // Warning: This reads entire collection. Optimization would be to use aggregation queries if available,
            // but for this scope we fetch all as requested to get accurate stats.
            const snapshot = await getDocs(collection(db, "logs"));
            window.cachedAllLogs = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            renderDashboard();
            window.hideLoading();
            Swal.fire({
              icon: "success",
              title: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              toast: true,
              position: "top-end",
              timer: 1500,
              showConfirmButton: false,
            });
          } catch (e) {
            window.hideLoading();
            Swal.fire("Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
          }
        }
      };

      // --- AUTH ---
      window.login = async (e) => {
        e.preventDefault();
        const inputId = document.getElementById("login-id").value.trim();
        const inputName = document.getElementById("login-name").value.trim();
        if (!inputId) return;

        window.showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...");

        try {
          let ipAddress = "Unknown";
          try {
            const ipRes = await fetch("https://api.ipify.org?format=json");
            if (ipRes.ok) {
              const ipJson = await ipRes.json();
              ipAddress = ipJson.ip;
            }
          } catch (err) {}

          const userAgent = navigator.userAgent;
          const q = query(
            collection(db, "users"),
            where("empId", "==", inputId),
          );
          const querySnapshot = await getDocs(q);

          let userData = null;
          let userDocId = null;

          if (!querySnapshot.empty) {
            const userDoc = querySnapshot.docs[0];
            userData = userDoc.data();
            userDocId = userDoc.id;

            if (userData.isBlocked) {
              window.hideLoading();
              Swal.fire({
                icon: "error",
                title: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö",
                text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)",
                confirmButtonText: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö",
              });
              return;
            }

            await setDoc(
              doc(db, "users", userDocId),
              {
                name: inputName || userData.name,
                lastLogin: new Date().toISOString(),
                lastLoginIp: ipAddress,
                userAgent: userAgent,
              },
              { merge: true },
            );

            userData.name = inputName || userData.name;
          } else {
            const newUser = {
              empId: inputId,
              name: inputName || `User ${inputId}`,
              role: inputId === "9999" ? "admin" : "user",
              createdAt: new Date().toISOString(),
              lastLogin: new Date().toISOString(),
              lastLoginIp: ipAddress,
              userAgent: userAgent,
              isBlocked: false,
            };

            const docRef = await addDoc(collection(db, "users"), newUser);
            userData = newUser;
            userDocId = docRef.id;
          }

          const user = {
            docId: userDocId,
            empId: userData.empId,
            name: userData.name,
            role: userData.role || "user",
            isBlocked: userData.isBlocked || false,
          };

          localStorage.setItem("ems_user_fb", JSON.stringify(user));
          window.hideLoading();
          initApp(user);
        } catch (err) {
          console.error(err);
          window.hideLoading();
          Swal.fire("Login Error", "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", "error");
        }
      };

      document
        .getElementById("login-form")
        .addEventListener("submit", window.login);

      window.logout = () => {
        localStorage.removeItem("ems_user_fb");
        if (window.refreshTimerId) clearInterval(window.refreshTimerId);
        if (unsubscribeInventory) unsubscribeInventory(); // ADDED: Clean up listeners
        if (unsubscribeUsers) unsubscribeUsers();
        if (unsubscribeActiveLogs) unsubscribeActiveLogs();
        location.reload();
      };

      async function initApp(user) {
        if (user.isBlocked) {
          Swal.fire({
            icon: "error",
            title: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö",
            text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö",
          }).then(() => window.logout());
          return;
        }

        window.currentUser = user;
        document.getElementById("user-display-name").innerText = user.name;

        let roleText = "User";
        if (user.role === "admin") roleText = "Admin";
        else if (user.role === "assistant") roleText = "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ Admin";
        document.getElementById("user-display-role").innerText = roleText;

        const mobileName = document.getElementById("mobile-user-name");
        if (mobileName) mobileName.innerText = user.name;
        const mobileRole = document.getElementById("mobile-user-role");
        if (mobileRole) mobileRole.innerText = roleText;

        const iconBg = document.getElementById("user-role-icon-bg");
        iconBg.className =
          "w-9 h-9 rounded-full border-2 border-white dark:border-gray-600 flex items-center justify-center ";
        if (user.role === "admin") {
          iconBg.className +=
            "bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300";
        } else if (user.role === "assistant") {
          iconBg.className +=
            "bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300";
        } else {
          iconBg.className +=
            "bg-primary-100 text-primary-600 dark:bg-primary-900 dark:text-primary-300";
        }

        const adminGroup = document.getElementById("admin-menu-container");
        const verifyTab = document.getElementById("tab-verify");
        const btnMenuUsers = document.getElementById("btn-menu-users");

        // ADDED: Logic to control History tab visibility in Navbar
        const historyTab = document.getElementById("tab-history");

        const isSuperAdmin = user.role === "admin";
        const isAssistant = user.role === "assistant";
        const canManageStock = isSuperAdmin || isAssistant;

        if (canManageStock) {
          adminGroup.classList.remove("hidden");
          verifyTab.classList.remove("hidden");
          // Show History tab in navbar for Admin/Assistant
          if (historyTab) historyTab.classList.remove("hidden");
        } else {
          adminGroup.classList.add("hidden");
          verifyTab.classList.add("hidden");
          // Hide History tab in navbar for regular Users
          if (historyTab) historyTab.classList.add("hidden");
        }

        if (isSuperAdmin) {
          btnMenuUsers.classList.remove("hidden");
        } else {
          btnMenuUsers.classList.add("hidden");
        }

        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("app-screen").classList.remove("hidden");

        renderSkeleton();

        // Start Realtime
        startRealtimeListeners();

        switchTab("inventory");
      }

      function renderSkeleton() {
        const grid = document.getElementById("inventory-grid");
        grid.innerHTML = "";
        for (let i = 0; i < 10; i++) {
          grid.innerHTML += `
                <div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-row md:flex-col h-auto md:h-full animate-pulse overflow-hidden">
                    <div class="w-1/3 md:w-full h-auto md:h-40 bg-gray-200 dark:bg-gray-700"></div>
                    <div class="p-4 flex flex-col flex-1 w-2/3 md:w-full">
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-2"></div>
                        <div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-4"></div>
                        <div class="flex-1"></div>
                        <div class="h-8 md:h-10 bg-gray-200 dark:bg-gray-700 rounded-xl w-full mt-2 md:mt-4"></div>
                    </div>
                </div>
            `;
        }
      }

      // --- CORE LOGIC (BORROW) ---
      window.openBorrowModal = (id) => {
        const item = window.inventoryData.find((i) => i.id == id);
        if (!item) return;
        window.currentBorrowItemId = id;
        document.getElementById("borrow-item-name").innerText = item.name;
        document.getElementById("borrow-item-max").innerText = item.remaining;

        const imgPreview = document.getElementById("borrow-img-preview");
        imgPreview.src = item.image || "https://placehold.co/100";
        imgPreview.onclick = function () {
          window.openImageModal(this.src);
        };

        document.getElementById("borrow-qty").max = item.remaining;
        document.getElementById("borrow-qty").value = 1;
        document.getElementById("borrow-modal").classList.remove("hidden");
      };

      window.confirmBorrow = async () => {
        const qty = parseInt(document.getElementById("borrow-qty").value);
        const itemId = window.currentBorrowItemId;
        const btn = document.getElementById("btn-confirm-borrow");

        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

        try {
          const borrowDate = new Date().toISOString();
          const newLogId = "temp_" + Date.now();

          await runTransaction(db, async (transaction) => {
            const itemRef = doc(db, "inventory", itemId);
            const itemDoc = await transaction.get(itemRef);
            if (!itemDoc.exists()) throw new Error("ItemNotFound");

            const currentItemData = itemDoc.data();
            const currentRemaining = currentItemData.remaining;

            if (currentRemaining < qty) {
              throw new Error("OutOfStock");
            }

            transaction.update(itemRef, { remaining: currentRemaining - qty });

            const newLogRef = doc(collection(db, "logs"));
            transaction.set(newLogRef, {
              itemId: itemId,
              itemName: currentItemData.name,
              borrowerName: window.currentUser.name,
              empId: window.currentUser.empId,
              borrowDate: borrowDate,
              status: "borrowed",
              qty: qty,
              returnDate: null,
            });
          });

          // UPDATE LOCAL DATA MANUALLY (Since realtime is gone for logs)
          await fetchActiveLogs();

          closeModal("borrow-modal");
          Swal.fire({
            icon: "success",
            title: "‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
            timer: 1500,
            showConfirmButton: false,
          });
        } catch (e) {
          console.error("Borrow Error:", e);
          closeModal("borrow-modal");

          let title = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ";
          let text = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";

          if (
            e.message === "OutOfStock" ||
            e.toString().includes("OutOfStock")
          ) {
            title = "‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß";
            text = "‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏¢‡∏∑‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏π‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß";
          } else if (e.message === "ItemNotFound") {
            text = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
          }

          await Swal.fire({
            icon: "error",
            title: title,
            text: text,
            timer: 4000,
            timerProgressBar: true,
            showConfirmButton: true,
            confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á",
          });
        } finally {
          btn.disabled = false;
          btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
        }
      };

      // --- LOGIC FOR ADMIN & HISTORY ---
      window.requestReturn = async (logId) => {
        const result = await Swal.fire({
          title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô?",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        });
        if (result.isConfirmed) {
          try {
            await updateDoc(doc(db, "logs", logId), {
              status: "pending_return",
            });
            // Update local state manually
            await fetchActiveLogs();
          } catch (e) {
            console.error(e);
            Swal.fire("Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ", "error");
          }
        }
      };

      window.returnAllItems = async () => {
        const result = await Swal.fire({
          title: "‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        });
        if (result.isConfirmed) {
          try {
            const batch = writeBatch(db);
            let count = 0;
            window.activeLogs.forEach((log) => {
              if (
                log.empId == window.currentUser.empId &&
                log.status === "borrowed"
              ) {
                batch.update(doc(db, "logs", log.id), {
                  status: "pending_return",
                });
                count++;
              }
            });
            if (count > 0) {
              await batch.commit();
              await fetchActiveLogs();
            }
          } catch (e) {
            console.error(e);
            Swal.fire("Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
          }
        }
      };

      window.adminConfirmReturn = async (logId) => {
        try {
          await runTransaction(db, async (transaction) => {
            const logRef = doc(db, "logs", logId);
            const logDoc = await transaction.get(logRef);
            if (!logDoc.exists()) throw "Log not found";
            const logData = logDoc.data();
            const itemRef = doc(db, "inventory", logData.itemId);
            const itemDoc = await transaction.get(itemRef);

            transaction.update(logRef, {
              status: "returned",
              returnDate: new Date().toISOString(),
            });

            if (itemDoc.exists()) {
              transaction.update(itemRef, {
                remaining: (itemDoc.data().remaining || 0) + logData.qty,
              });
            }
          });

          // Update local state
          await fetchActiveLogs();
        } catch (e) {
          Swal.fire("Error", e.toString(), "error");
        }
      };

      window.verifyAllReturns = async () => {
        const pending = window.activeLogs.filter(
          (l) => l.status === "pending_return",
        );
        for (const log of pending) await window.adminConfirmReturn(log.id);
        Swal.fire({
          icon: "success",
          title: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
          timer: 1500,
          showConfirmButton: false,
        });
      };

      window.deleteLog = async (logId) => {
        const result = await Swal.fire({
          title: "‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?",
          text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Stock ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£",
        });
        if (result.isConfirmed) {
          try {
            await deleteDoc(doc(db, "logs", logId));

            // Update local arrays
            window.selectedLogIds.delete(logId);
            window.historyLogs = window.historyLogs.filter(
              (l) => l.id !== logId,
            );
            window.activeLogs = window.activeLogs.filter((l) => l.id !== logId);
            window.cachedAllLogs = window.cachedAllLogs.filter(
              (l) => l.id !== logId,
            );

            // Re-render history
            renderHistory();

            // Clear selection logic if needed
            if (window.selectedLogIds.size === 0) {
              document
                .getElementById("history-action-area")
                .classList.add("hidden");
              document
                .getElementById("history-action-area")
                .classList.remove("flex");
            }

            Swal.fire({
              icon: "success",
              title: "‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              timer: 1000,
              showConfirmButton: false,
            });
          } catch (e) {
            Swal.fire("Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ", "error");
          }
        }
      };

      window.toggleSelectAll = (source) => {
        const checkboxes = document.querySelectorAll(".log-checkbox");
        checkboxes.forEach((cb) => (cb.checked = source.checked));
      };

      window.deleteSelectedLogs = async () => {
        const checkboxes = document.querySelectorAll(".log-checkbox:checked");
        const idsToDelete = new Set([...window.selectedLogIds]);
        checkboxes.forEach((cb) => idsToDelete.add(cb.value));

        if (idsToDelete.size === 0) {
          Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö", "warning");
          return;
        }

        const result = await Swal.fire({
          title: `‡∏•‡∏ö ${idsToDelete.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`,
          text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Stock ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        });

        if (result.isConfirmed) {
          try {
            const batch = writeBatch(db);
            idsToDelete.forEach((id) => {
              const ref = doc(db, "logs", id);
              batch.delete(ref);
            });
            await batch.commit();

            window.selectedLogIds.clear();
            document
              .getElementById("history-action-area")
              .classList.add("hidden");
            document
              .getElementById("history-action-area")
              .classList.remove("flex");

            // Refresh Current view
            await window.searchHistoryByDate();
          } catch (e) {
            Swal.fire("Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", "error");
          }
        }
      };

      window.toggleLogSelection = (id, cardElement) => {
        const btnArea = document.getElementById("history-action-area");
        const selectionCount = document.getElementById("selection-count");

        if (window.selectedLogIds.has(id)) {
          window.selectedLogIds.delete(id);
          cardElement.classList.remove(
            "card-selected",
            "ring-2",
            "ring-primary-500",
          );
        } else {
          window.selectedLogIds.add(id);
          cardElement.classList.add(
            "card-selected",
            "ring-2",
            "ring-primary-500",
          );
        }

        if (window.selectedLogIds.size > 0) {
          btnArea.classList.remove("hidden");
          btnArea.classList.add("flex");
          selectionCount.innerText = `${window.selectedLogIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        } else {
          btnArea.classList.add("hidden");
          btnArea.classList.remove("flex");
        }
      };

      window.toggleSelectAllMobile = () => {
        const canManage =
          window.currentUser.role === "admin" ||
          window.currentUser.role === "assistant";

        let logs = window.historyLogs; // Use History Logs

        const allSelected = logs.every((log) =>
          window.selectedLogIds.has(log.id),
        );

        if (allSelected) {
          window.selectedLogIds.clear();
          document.getElementById("select-all-text").innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
        } else {
          logs.forEach((log) => window.selectedLogIds.add(log.id));
          document.getElementById("select-all-text").innerText = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
        }

        renderHistory();

        const btnArea = document.getElementById("history-action-area");
        const selectionCount = document.getElementById("selection-count");

        if (window.selectedLogIds.size > 0) {
          btnArea.classList.remove("hidden");
          btnArea.classList.add("flex");
          selectionCount.innerText = `${window.selectedLogIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        } else {
          btnArea.classList.add("hidden");
          btnArea.classList.remove("flex");
        }
      };

      window.changeUserRole = async (userId, selectElement) => {
        const newRole = selectElement.value;
        try {
          await updateDoc(doc(db, "users", userId), { role: newRole });
          Swal.fire({
            icon: "success",
            title: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            toast: true,
            position: "top-end",
            timer: 2000,
            showConfirmButton: false,
          });
        } catch (e) {
          Swal.fire("Error", e.message, "error");
        }
      };

      window.toggleUserBlock = async (userId, currentBlockStatus) => {
        const newStatus = !currentBlockStatus;
        const actionText = newStatus ? "‡∏£‡∏∞‡∏á‡∏±‡∏ö (Block)" : "‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ";
        const result = await Swal.fire({
          title: `${actionText}?`,
          text: newStatus
            ? "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ"
            : "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: actionText,
          confirmButtonColor: newStatus ? "#ef4444" : "#22c55e",
        });

        if (result.isConfirmed) {
          try {
            await updateDoc(doc(db, "users", userId), { isBlocked: newStatus });
            // Realtime listener will handle UI update
            Swal.fire({
              icon: "success",
              title: "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              toast: true,
              position: "top-end",
              timer: 2000,
              showConfirmButton: false,
            });
          } catch (e) {
            Swal.fire("Error", e.message, "error");
          }
        }
      };

      window.showDeviceInfo = (name, ip, agent, lastLogin) => {
        Swal.fire({
          title: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",
          html: `
                  <div class="text-left text-sm space-y-3 p-2">
                      <div>
                          <p class="text-gray-500 font-bold text-xs uppercase">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                          <p class="text-gray-800 dark:text-gray-200">${name}</p>
                      </div>
                      <div>
                          <p class="text-gray-500 font-bold text-xs uppercase">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                          <p class="text-gray-800 dark:text-gray-200">${new Date(lastLogin).toLocaleString("th-TH")}</p>
                      </div>
                      <div>
                          <p class="text-gray-500 font-bold text-xs uppercase">IP Address</p>
                          <p class="font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded inline-block">${ip || "Unknown"}</p>
                      </div>
                      <div>
                          <p class="text-gray-500 font-bold text-xs uppercase">Browser / Device</p>
                          <p class="text-xs text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-gray-700 rounded p-2 bg-gray-50 dark:bg-gray-800 mt-1">${agent || "Unknown"}</p>
                      </div>
                  </div>
              `,
          confirmButtonText: "‡∏õ‡∏¥‡∏î",
        });
      };

      window.deleteUser = async (userId) => {
        const result = await Swal.fire({
          title: "‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô?",
          text: "‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£",
          cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
        });

        if (result.isConfirmed) {
          try {
            await deleteDoc(doc(db, "users", userId));
            // Realtime update
            Swal.fire({
              icon: "success",
              title: "‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              toast: true,
              position: "top-end",
              timer: 2000,
              showConfirmButton: false,
            });
          } catch (e) {
            Swal.fire("Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ: " + e.message, "error");
          }
        }
      };

      // --- GAS UPLOAD HELPER ---
      async function uploadImageToGAS(base64Data, fileName) {
        if (!base64Data || !base64Data.startsWith("data:image")) {
          return base64Data;
        }

        const response = await fetch(GAS_API_URL, {
          redirect: "follow",
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify({
            action: "uploadImage",
            image: base64Data,
            name: fileName,
          }),
        });

        if (!response.ok) throw new Error("Network response was not ok");

        const result = await response.json();
        if (result.status === "success") return result.url;
        throw new Error(result.message || "Upload to Google Drive failed");
      }

      // --- ADMIN: ITEM MANAGEMENT ---
      document
        .getElementById("item-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          window.showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

          const id = document.getElementById("item-id").value;
          const name = document.getElementById("item-name").value;
          const stock = parseInt(document.getElementById("item-stock").value);

          const sourceType = document.querySelector(
            'input[name="img-source"]:checked',
          ).value;

          let image = "";
          try {
            if (sourceType === "file") {
              const base64 = document.getElementById(
                "item-image-temp-base64",
              ).value;
              if (base64 && base64.startsWith("data:image")) {
                image = await uploadImageToGAS(
                  base64,
                  `${name}_${Date.now()}.jpg`,
                );
              } else {
                image = document.getElementById("item-image-preview").src;
              }
            } else {
              const url = document.getElementById("item-image-url").value;
              image = window.formatGoogleDriveLink(url);
            }

            if (!image || image.includes("placehold.co") || image === "") {
              image = "https://placehold.co/300x200?text=No+Image";
            }

            const itemData = {
              name,
              category: window.tempTags,
              stock,
              image,
            };

            if (id) {
              const oldItem = window.inventoryData.find((i) => i.id == id);
              const borrowed = oldItem.stock - oldItem.remaining;
              itemData.remaining = stock - borrowed;
              await updateDoc(doc(db, "inventory", id), itemData);
            } else {
              itemData.remaining = stock;
              await addDoc(collection(db, "inventory"), itemData);
            }

            // No manual reload needed

            closeModal("item-modal");
            Swal.fire({
              icon: "success",
              title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
              timer: 1500,
              showConfirmButton: false,
            });
          } catch (error) {
            console.error("Save Error:", error);
            Swal.fire(
              "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
              error.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ",
              "error",
            );
          } finally {
            window.hideLoading();
          }
        });

      window.toggleImageSource = (type) => {
        document
          .getElementById("input-type-file")
          .classList.toggle("hidden", type !== "file");
        document
          .getElementById("input-type-url")
          .classList.toggle("hidden", type !== "url");
      };

      document
        .getElementById("item-image-url")
        .addEventListener("input", (e) => {
          if (e.target.value)
            document.getElementById("item-image-preview").src =
              window.formatGoogleDriveLink(e.target.value);
        });

      window.openAddModal = () => {
        document.getElementById("item-modal-title").innerText =
          "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà";
        document.getElementById("item-form").reset();
        document.getElementById("item-id").value = "";
        document.getElementById("item-image-temp-base64").value = "";
        document.getElementById("item-image-preview").src =
          "https://placehold.co/100?text=Preview";
        document.querySelector(
          'input[name="img-source"][value="file"]',
        ).checked = true;
        window.toggleImageSource("file");

        window.tempTags = [];
        window.renderTagsInModal();

        document.getElementById("item-modal").classList.remove("hidden");
      };

      window.editItem = (id) => {
        const item = window.inventoryData.find((i) => i.id == id);
        document.getElementById("item-modal-title").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå";
        document.getElementById("item-id").value = id;
        document.getElementById("item-name").value = item.name;
        document.getElementById("item-stock").value = item.stock;
        document.getElementById("item-image-temp-base64").value = "";

        const isUrl =
          item.image &&
          item.image.startsWith("http") &&
          !item.image.startsWith("data:");

        document.querySelector(
          `input[name="img-source"][value="${isUrl ? "url" : "file"}"]`,
        ).checked = true;
        window.toggleImageSource(isUrl ? "url" : "file");

        if (isUrl) {
          document.getElementById("item-image-url").value = item.image;
        }

        document.getElementById("item-image-preview").src =
          item.image || "https://placehold.co/100";

        window.tempTags = window.getCategoryArray(item);
        window.renderTagsInModal();

        document.getElementById("item-modal").classList.remove("hidden");
      };

      window.deleteItem = async (id) => {
        const item = window.inventoryData.find((i) => i.id == id);
        const result = await Swal.fire({
          title: "‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?",
          text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Google Drive ‡∏î‡πâ‡∏ß‡∏¢",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "‡∏•‡∏ö",
        });

        if (result.isConfirmed) {
          window.showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

          try {
            if (
              item &&
              item.image &&
              (item.image.includes("drive.google.com") ||
                item.image.includes("googleusercontent.com/d/"))
            ) {
              const fileId = item.image.match(
                /id=([-\w]{25,})|d\/([-\w]{25,})/,
              );
              const actualFileId = fileId ? fileId[1] || fileId[2] : null;

              if (actualFileId) {
                await fetch(GAS_API_URL, {
                  redirect: "follow",
                  method: "POST",
                  headers: { "Content-Type": "text/plain;charset=utf-8" },
                  body: JSON.stringify({
                    action: "deleteImage",
                    fileId: actualFileId,
                  }),
                });
              }
            }

            await deleteDoc(doc(db, "inventory", id));
            // No manual reload

            Swal.fire({
              icon: "success",
              title: "‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
              timer: 1000,
              showConfirmButton: false,
            });
          } catch (error) {
            console.error("Delete error:", error);
            Swal.fire(
              "Error",
              "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: " + error.message,
              "error",
            );
          } finally {
            window.hideLoading();
          }
        }
      };

      // --- RENDER FUNCTIONS ---
      function renderInventory() {
        const grid = document.getElementById("inventory-grid");
        const search = document
          .getElementById("search-inventory")
          .value.toLowerCase();
        const catFilter = document.getElementById("filter-category").value;
        grid.innerHTML = "";
        const items = window.inventoryData.filter((i) => {
          const matchName = i.name.toLowerCase().includes(search);
          const itemTags = window.getCategoryArray(i);
          const matchCat = catFilter ? itemTags.includes(catFilter) : true;
          return matchName && matchCat;
        });

        const activeFilterDisplay = document.getElementById(
          "active-filter-display",
        );
        if (catFilter) {
          const colorClass = window.getTagColor(catFilter);
          activeFilterDisplay.classList.remove("hidden");
          activeFilterDisplay.innerHTML = `
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full ${colorClass} shadow-sm text-sm font-medium">
                    <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á: ${catFilter}</span>
                    <button onclick="clearFilter()" class="hover:bg-black/10 rounded-full w-5 h-5 flex items-center justify-center transition">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `;
        } else {
          activeFilterDisplay.classList.add("hidden");
          activeFilterDisplay.innerHTML = "";
        }

        items.forEach((item) => {
          const isOut = item.remaining <= 0;
          const tags = window.getCategoryArray(item);
          const tagsHtml = tags
            .map((t) => {
              const colorClass = window.getTagColor(t);
              return `<span class="${colorClass} px-2 py-0.5 rounded text-[10px] cursor-pointer hover:opacity-80 transition" onclick="event.stopPropagation(); window.filterByTag('${t}')">${t}</span>`;
            })
            .join(" ");

          const cardClass = isOut
            ? "bg-white dark:bg-dark-card rounded-2xl border border-gray-100 dark:border-gray-700 flex flex-row md:flex-col h-auto md:h-full overflow-hidden opacity-60"
            : "bg-white dark:bg-dark-card rounded-2xl shadow-sm hover:shadow-md transition border border-gray-100 dark:border-gray-700 flex flex-row md:flex-col h-auto md:h-full group overflow-hidden";

          grid.innerHTML += `
                    <div class="${cardClass}">
                        <div class="w-1/3 md:w-full h-auto md:h-40 overflow-hidden relative bg-gray-100 dark:bg-gray-800 min-h-[120px] md:min-h-0">
                            <img 
                                src="${item.image}" 
                                referrerpolicy="no-referrer" 
                                class="w-full h-full object-cover cursor-pointer hover:opacity-90 transition ${isOut ? "" : "group-hover:scale-105 duration-500"}" 
                                onclick="event.stopPropagation(); window.openImageModal('${item.image}')"
                                onerror="handleImageError(this)"
                            >
                            <span class="absolute top-2 right-2 px-2 py-1 text-xs font-bold rounded-full ${isOut ? "bg-red-500 text-white" : "bg-green-500 text-white"} shadow-sm text-[10px] md:text-xs pointer-events-none">
                                ${
                                  isOut
                                    ? "‡∏´‡∏°‡∏î"
                                    : item.remaining === item.stock
                                      ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.remaining}`
                                      : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.remaining} ‡∏à‡∏≤‡∏Å ${item.stock}`
                                }
                            </span>
                        </div>
                        <div class="p-3 md:p-4 flex flex-col flex-1 w-2/3 md:w-full justify-between">
                            <div>
                                <div class="flex flex-wrap gap-1 mb-1">${tagsHtml || '<span class="text-[10px] text-gray-400">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>'}</div>
                                <h3 class="font-bold text-gray-800 dark:text-gray-100 text-base md:text-lg mb-1 leading-snug line-clamp-2">${item.name}</h3>
                            </div>
                            <button onclick="openBorrowModal('${item.id}')" ${isOut ? "disabled" : ""} class="mt-2 md:mt-4 w-full py-1.5 md:py-2.5 rounded-lg md:rounded-xl font-medium transition flex items-center justify-center gap-2 text-xs md:text-sm ${isOut ? "bg-gray-100 text-gray-400 cursor-not-allowed" : "bg-primary-600 text-white hover:bg-primary-700 shadow"}">
                                ${isOut ? "‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î" : "‡∏¢‡∏∑‡∏°"}
                            </button>
                        </div>
                    </div>`;
        });
      }

      // --- ADDED MISSING RENDER ADMIN TABLE ---
      function renderAdminTable() {
        const container = document.getElementById("admin-inventory-container");
        if (!container) return;

        const catFilter = document.getElementById(
          "admin-filter-category",
        ).value;

        const items = window.inventoryData.filter((i) => {
          const itemTags = window.getCategoryArray(i);
          const matchCat = catFilter ? itemTags.includes(catFilter) : true;
          return matchCat;
        });

        // Desktop Table
        let tableRowsHtml = "";
        items.forEach((item) => {
          const tags = window.getCategoryArray(item);
          const tagsHtml = tags
            .map((t) => {
              const colorClass = window.getTagColor(t);
              return `<span class="inline-block text-[10px] ${colorClass} px-1.5 rounded mr-1 mb-1">${t}</span>`;
            })
            .join("");

          tableRowsHtml += `
                    <tr class="bg-white border-b dark:bg-dark-card dark:border-gray-700">
                        <td class="px-4 py-3 text-center">
                            <img 
                                src="${item.image}" 
                                referrerpolicy="no-referrer" 
                                class="w-10 h-10 rounded object-cover mx-auto cursor-pointer hover:opacity-80 transition" 
                                onclick="window.openImageModal('${item.image}')"
                                onerror="handleImageError(this)"
                            >
                        </td>
                        <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">${item.name}</td>
                        <td class="px-4 py-3 text-gray-500">
                            <div class="flex flex-wrap max-w-[150px]">${tagsHtml}</div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${item.remaining === 0 ? "text-red-500 font-bold" : "text-gray-700 dark:text-gray-300"}">${item.remaining}</span>
                            <span class="text-gray-400">/${item.stock}</span>
                        </td>
                        <td class="px-4 py-3 text-center space-x-2">
                            <button onclick="editItem('${item.id}')" class="text-primary-600 hover:text-primary-800"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem('${item.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
        });

        // Mobile Cards
        let mobileCardsHtml = "";
        items.forEach((item) => {
          const tags = window.getCategoryArray(item);
          const tagsHtml = tags
            .map((t) => {
              const colorClass = window.getTagColor(t);
              return `<span class="text-[10px] ${colorClass} px-2 py-0.5 rounded">${t}</span>`;
            })
            .join(" ");

          mobileCardsHtml += `
            <div class="bg-white dark:bg-dark-card rounded-xl p-3 shadow-sm border border-gray-100 dark:border-gray-700 flex gap-3 items-center">
                <div class="relative w-16 h-16 flex-shrink-0">
                    <img 
                        src="${item.image}" 
                        referrerpolicy="no-referrer" 
                        class="w-full h-full rounded-lg object-cover bg-gray-100" 
                        onerror="handleImageError(this)"
                        onclick="window.openImageModal('${item.image}')"
                    >
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap gap-1 mb-1">${tagsHtml}</div>
                    <div class="font-bold text-gray-800 dark:text-gray-100 text-sm truncate mb-1">${item.name}</div>
                    <div class="text-xs">
                       ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="${item.remaining === 0 ? "text-red-500 font-bold" : "font-medium"}">${item.remaining}</span> / ${item.stock}
                    </div>
                </div>
                <div class="flex flex-col gap-2 border-l border-gray-100 dark:border-gray-700 pl-3">
                    <button onclick="editItem('${item.id}')" class="text-primary-600 p-1"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteItem('${item.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            `;
        });

        container.innerHTML = `
             <!-- Desktop Table -->
            <div class="hidden md:block bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700 overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 border-b dark:border-gray-600">
                        <tr>
                            <th class="px-4 py-3 w-16 text-center">‡∏£‡∏π‡∏õ</th>
                            <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th class="px-4 py-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th class="px-4 py-3 text-center">Stock</th>
                            <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        ${tableRowsHtml}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="md:hidden space-y-3">
                 ${mobileCardsHtml || '<div class="text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'}
            </div>
        `;
      }

      function renderMyItems() {
        // UPDATED: Use window.activeLogs instead of window.transactionLogs
        const activeList = document.getElementById("my-items-active-list");
        const pendingList = document.getElementById("my-items-pending-list");
        const badge = document.getElementById("my-items-badge");
        const returnAllBtn = document.getElementById("btn-return-all");

        activeList.innerHTML = "";
        pendingList.innerHTML = "";

        const myLogs = window.activeLogs.filter(
          (l) => l.empId == window.currentUser.empId,
        );
        const active = myLogs.filter((l) => l.status === "borrowed");
        const pending = myLogs.filter((l) => l.status === "pending_return");

        document
          .getElementById("my-items-active-empty")
          .classList.toggle("hidden", active.length > 0);
        document
          .getElementById("my-items-pending-empty")
          .classList.toggle("hidden", pending.length > 0);

        const totalBadgeCount = active.length + pending.length;
        if (totalBadgeCount > 0) {
          badge.classList.remove("hidden");
          badge.innerText = totalBadgeCount;
        } else {
          badge.classList.add("hidden");
        }

        if (active.length > 0) {
          returnAllBtn.classList.remove("hidden");
        } else {
          returnAllBtn.classList.add("hidden");
        }

        const createCard = (log, isActive) => {
          const item =
            window.inventoryData.find((i) => i.id == log.itemId) || {};
          const date = new Date(log.borrowDate).toLocaleDateString("th-TH");
          const btn = isActive
            ? `<button onclick="requestReturn('${log.id}')" class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow flex-shrink-0"><i class="fas fa-undo"></i></button>`
            : `<div class="text-yellow-500 text-xl flex-shrink-0"><i class="fas fa-clock"></i></div>`;

          const nameHtml = window.createMarqueeHtml(log.itemName);

          return `
                    <div class="bg-white dark:bg-dark-card p-4 rounded-xl border-l-4 ${isActive ? "border-primary-500" : "border-yellow-500"} shadow-sm flex items-center gap-4 overflow-hidden">
                        <img src="${item.image || "https://placehold.co/100"}" referrerpolicy="no-referrer" class="w-16 h-16 rounded-lg object-cover bg-gray-100 flex-shrink-0" onerror="handleImageError(this)">
                        <div class="flex-1 min-w-0 overflow-hidden">
                            ${nameHtml}
                            <div class="text-xs text-gray-500 mt-1">‡∏¢‡∏∑‡∏°: ${date}</div>
                            <div class="mt-2"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-md font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${log.qty}</span></div>
                        </div>
                        ${btn}
                    </div>`;
        };

        active.forEach((l) => (activeList.innerHTML += createCard(l, true)));
        pending.forEach((l) => (pendingList.innerHTML += createCard(l, false)));
      }

      function renderVerify() {
        // UPDATED: Use window.activeLogs
        const list = document.getElementById("verify-list");
        const badge = document.getElementById("verify-badge");
        const verifyAllBtn = document.getElementById("btn-verify-all");
        list.innerHTML = "";

        // Filter only pending items from Active Logs
        const pending = window.activeLogs.filter(
          (l) => l.status === "pending_return",
        );

        if (pending.length > 0) {
          badge.classList.remove("hidden");
          badge.innerText = pending.length;
          verifyAllBtn.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
          verifyAllBtn.classList.add("hidden");
        }
        document
          .getElementById("verify-empty")
          .classList.toggle("hidden", pending.length > 0);

        pending.forEach((log) => {
          const item =
            window.inventoryData.find((i) => i.id == log.itemId) || {};
          const nameHtml = window.createMarqueeHtml(log.itemName, 15);

          list.innerHTML += `
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-yellow-200 dark:border-yellow-700 overflow-hidden flex flex-row p-3 gap-3 items-center">
                        <img src="${item.image || "https://placehold.co/100"}" referrerpolicy="no-referrer" class="w-12 h-12 rounded-lg object-cover flex-shrink-0 bg-gray-100" onerror="handleImageError(this)">
                        
                        <div class="flex-1 min-w-0 overflow-hidden">
                            ${nameHtml}
                            <div class="text-xs text-gray-500 mt-0.5 truncate">${log.borrowerName}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-1.5 rounded text-gray-500">ID: ${log.empId}</span>
                                <span class="text-[10px] bg-blue-50 text-blue-600 px-1.5 rounded font-bold">x${log.qty}</span>
                            </div>
                        </div>
                        
                        <button onclick="adminConfirmReturn('${log.id}')" class="h-9 w-9 flex items-center justify-center bg-green-100 hover:bg-green-200 text-green-700 rounded-full flex-shrink-0 transition">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>`;
        });
      }

      function renderHistory() {
        // UPDATED: Use window.historyLogs which is populated by Search
        const container = document.getElementById("history-container");
        const canManage =
          window.currentUser.role === "admin" ||
          window.currentUser.role === "assistant";

        // If history logs are empty but no search done yet, we show default state handled in HTML
        if (window.historyLogs.length === 0) {
          const datePicker = document.getElementById("history-date-picker");
          if (datePicker.value && window.historyLogs.length === 0) {
            // Search done but no result - this is handled by searchHistoryByDate showing alert
            // But we should also clear the container to show empty message if needed
            container.innerHTML = `
                    <div class="text-center py-12 bg-white dark:bg-dark-card rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                        <i class="fas fa-search-minus text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                    </div>`;
          }
          return;
        }

        let headerHtml = "";
        if (canManage) {
          headerHtml += `<th class="px-4 py-3 w-10 text-center"><input type="checkbox" onchange="toggleSelectAll(this)" class="rounded text-primary-600 focus:ring-primary-500 cursor-pointer"></th>`;
        }
        headerHtml += `
                <th class="px-4 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th>
                <th class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
                <th class="px-4 py-3">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                <th class="px-4 py-3 text-center">‡∏£‡∏π‡∏õ</th>
                <th class="px-4 py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="px-4 py-3 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th>
            `;

        let logs = [...window.historyLogs];
        // Sorting handled in fetch, but safeguard here
        // Filtering by user also handled in fetch

        const bulkBtn = document.getElementById("btn-bulk-delete");
        if (bulkBtn) bulkBtn.classList.toggle("hidden", !canManage);

        let tableRowsHtml = "";
        logs.forEach((log) => {
          const status =
            log.status === "borrowed"
              ? '<span class="text-blue-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</span>'
              : log.status === "pending_return"
                ? '<span class="text-yellow-500 font-medium animate-pulse">‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô</span>'
                : '<span class="text-green-500 font-medium">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';

          const borrowDateTime = new Date(log.borrowDate).toLocaleString(
            "th-TH",
            { dateStyle: "short", timeStyle: "short" },
          );
          const item =
            window.inventoryData.find((i) => i.id === log.itemId) || {};
          const returnDateTime = log.returnDate
            ? new Date(log.returnDate).toLocaleString("th-TH", {
                dateStyle: "short",
                timeStyle: "short",
              })
            : "-";

          let checkCell = "";
          let deleteBtn = "";

          if (canManage) {
            checkCell = `<td class="px-4 py-3 text-center"><input type="checkbox" class="log-checkbox rounded text-primary-600 focus:ring-primary-500 cursor-pointer" value="${log.id}"></td>`;
            deleteBtn = `<button onclick="deleteLog('${log.id}')" class="text-red-400 hover:text-red-600 ml-2" title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"><i class="fas fa-trash-alt"></i></button>`;
          }

          tableRowsHtml += `
                    <tr class="bg-white dark:bg-dark-card border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        ${checkCell}
                        <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">${borrowDateTime}</td>
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900 dark:text-white">${log.borrowerName}</div>
                            <div class="text-[11px] text-gray-400 font-light mt-0.5">ID: ${log.empId}</div>
                        </td>
                        <td class="px-4 py-3 text-gray-800 dark:text-gray-200">${log.itemName}</td>
                        <td class="px-4 py-3 text-center"><img src="${item.image || "https://placehold.co/100"}" class="w-10 h-10 rounded object-cover mx-auto cursor-pointer border" onclick="window.openImageModal('${item.image}')" onerror="handleImageError(this)"></td>
                        <td class="px-4 py-3 text-center font-bold text-gray-700 dark:text-gray-300">${log.qty}</td>
                        <td class="px-4 py-3 text-center text-sm whitespace-nowrap">${status}</td>
                        <td class="px-4 py-3 text-center text-sm text-gray-500 whitespace-nowrap">
                            ${returnDateTime}
                            ${deleteBtn}
                        </td>
                    </tr>`;
        });

        let mobileCardsHtml = "";
        logs.forEach((log) => {
          const statusBadge =
            log.status === "borrowed"
              ? '<span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 text-[10px] font-bold">‡∏¢‡∏∑‡∏°</span>'
              : log.status === "pending_return"
                ? '<span class="px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 text-[10px] font-bold animate-pulse">‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô</span>'
                : '<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px] font-bold">‡∏Ñ‡∏∑‡∏ô</span>';

          const dateStr = new Date(log.borrowDate).toLocaleString("th-TH", {
            day: "numeric",
            month: "short",
            year: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          const isSelected = window.selectedLogIds.has(log.id);
          const selectClass = isSelected
            ? "card-selected ring-2 ring-primary-500"
            : "";
          const onClickAttr = canManage
            ? `onclick="toggleLogSelection('${log.id}', this)"`
            : "";

          const item =
            window.inventoryData.find((i) => i.id === log.itemId) || {};

          mobileCardsHtml += `
            <div class="bg-white dark:bg-dark-card rounded-xl p-3 shadow-sm border border-gray-100 dark:border-gray-700 relative transition-all cursor-pointer ${selectClass}" ${onClickAttr}>
                <div class="flex justify-between items-start mb-2 pb-2 border-b border-gray-50 dark:border-gray-700">
                    <div class="flex items-center gap-1 text-xs text-gray-400">
                        <i class="far fa-clock"></i> ${dateStr}
                    </div>
                    ${statusBadge}
                </div>
                
                <div class="flex gap-3">
                    <img src="${item.image || "https://placehold.co/100"}" referrerpolicy="no-referrer" class="w-14 h-14 rounded-lg object-cover bg-gray-100 flex-shrink-0" onerror="handleImageError(this)">
                    
                    <div class="flex-1 min-w-0 flex flex-col justify-between">
                        <div>
                            <div class="font-bold text-gray-800 dark:text-gray-100 text-sm leading-tight break-words line-clamp-2">${log.itemName}</div>
                            <div class="text-[11px] text-gray-500 mt-1">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: <span class="font-medium">${log.borrowerName}</span></div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center justify-center pl-3 border-l border-gray-100 dark:border-gray-700">
                        <span class="text-[10px] text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                        <span class="text-sm font-bold text-primary-600 dark:text-primary-400">x${log.qty}</span>
                    </div>
                </div>
            </div>
            `;
        });

        container.innerHTML = `
            <div class="hidden md:block bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700 overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 border-b dark:border-gray-600">
                        <tr>${headerHtml}</tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        ${tableRowsHtml}
                    </tbody>
                </table>
            </div>
            <div class="md:hidden space-y-3">
                ${mobileCardsHtml || '<div class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>'}
            </div>
        `;
      }

      function renderUsers() {
        const container = document.getElementById("users-container");
        if (!container) return;

        let tableRowsHtml = "";
        let mobileCardsHtml = "";

        window.usersData.forEach((user) => {
          const isBlocked = user.isBlocked === true;

          const statusBadge = isBlocked
            ? '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-bold">‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</span>'
            : '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">‡∏õ‡∏Å‡∏ï‡∏¥</span>';

          let roleSelect = "";
          if (user.id === window.currentUser.docId) {
            roleSelect =
              '<span class="text-gray-400 text-xs">‡∏Ñ‡∏∏‡∏ì (Admin)</span>';
          } else {
            roleSelect = `
                    <select onchange="changeUserRole('${user.id}', this)" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-1 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                        <option value="user" ${user.role === "user" || !user.role ? "selected" : ""}>User</option>
                        <option value="assistant" ${user.role === "assistant" ? "selected" : ""}>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ Admin</option>
                        <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
                    </select>
                  `;
          }

          const toggleBlockBtn = isBlocked
            ? `<button onclick="toggleUserBlock('${user.id}', true)" class="text-green-600 hover:text-green-800" title="‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ"><i class="fas fa-unlock"></i></button>`
            : `<button onclick="toggleUserBlock('${user.id}', false)" class="text-red-400 hover:text-red-600" title="‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"><i class="fas fa-ban"></i></button>`;

          const infoBtn = `<button onclick="showDeviceInfo('${user.name}', '${user.lastLoginIp || ""}', '${user.userAgent || ""}', '${user.lastLogin || ""}')" class="text-blue-500 hover:text-blue-700" title="‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"><i class="fas fa-info-circle"></i></button>`;
          const deleteBtn = `<button onclick="deleteUser('${user.id}')" class="text-gray-400 hover:text-red-600" title="‡∏•‡∏ö User"><i class="fas fa-trash"></i></button>`;

          const isSelf = user.id === window.currentUser.docId;
          const actions = isSelf
            ? ""
            : `<div class="flex gap-3 justify-center text-base">${infoBtn} ${toggleBlockBtn} ${deleteBtn}</div>`;

          tableRowsHtml += `
                  <tr class="bg-white border-b dark:bg-dark-card dark:border-gray-700">
                      <td class="px-4 py-3 text-gray-600 dark:text-gray-400 text-xs">${user.empId}</td>
                      <td class="px-4 py-3">
                          <div class="font-medium text-gray-900 dark:text-white">${user.name}</div>
                          <div class="text-[10px] text-gray-400">Login: ${new Date(user.lastLogin).toLocaleDateString("th-TH")}</div>
                      </td>
                      <td class="px-4 py-3 text-center min-w-[100px]">${roleSelect}</td>
                      <td class="px-4 py-3 text-center">${statusBadge}</td>
                      <td class="px-4 py-3 text-center">${actions}</td>
                  </tr>
              `;

          mobileCardsHtml += `
                <div class="bg-white dark:bg-dark-card rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="text-xs text-gray-400 font-mono">#${user.empId}</div>
                            <div class="font-bold text-gray-800 dark:text-white text-base">${user.name}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                            ${roleSelect}
                        </div>
                    </div>
                     <div class="flex justify-end items-end gap-3 pb-1 mt-3 pt-2 border-t border-gray-50 dark:border-gray-700">
                        ${actions}
                     </div>
                </div>
              `;
        });

        container.innerHTML = `
              <div class="hidden md:block bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700 overflow-x-auto">
                  <table class="w-full text-sm text-left">
                      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 border-b dark:border-gray-600">
                          <tr>
                              <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                              <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                              <th class="px-4 py-3 text-center">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                              <th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                              <th class="px-4 py-3 text-center">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                          </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                          ${tableRowsHtml}
                      </tbody>
                  </table>
              </div>
              <div class="md:hidden space-y-3">
                  ${mobileCardsHtml || '<div class="text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'}
              </div>
          `;
      }

      function populateCategories() {
        const select = document.getElementById("filter-category");
        const adminSelect = document.getElementById("admin-filter-category");
        const dl = document.getElementById("category-list");

        const currentAdminVal = adminSelect.value;
        const currentVal = select.value;

        select.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
        adminSelect.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
        dl.innerHTML = "";

        const cats = new Set();
        window.inventoryData.forEach((item) => {
          const itemCats = window.getCategoryArray(item);
          itemCats.forEach((c) => cats.add(c));
        });

        cats.forEach((c) => {
          select.innerHTML += `<option value="${c}">${c}</option>`;
          adminSelect.innerHTML += `<option value="${c}">${c}</option>`;
          dl.innerHTML += `<option value="${c}">`;
        });

        select.value = currentVal;
        adminSelect.value = currentAdminVal;
      }

      function renderDashboard() {
        const role = window.currentUser.role;
        if (role !== "admin" && role !== "assistant") return;

        // UPDATED: Use cachedAllLogs if available, otherwise use activeLogs as fallback (but stats will be incomplete)
        const totalItems = window.inventoryData.reduce(
          (sum, i) => sum + i.stock,
          0,
        );

        let logsSource =
          window.cachedAllLogs.length > 0
            ? window.cachedAllLogs
            : window.activeLogs;

        // Show indicator if data is partial
        const totalLogsText =
          window.cachedAllLogs.length > 0
            ? window.cachedAllLogs.length
            : "N/A (Update)";

        const activeBorrows = window.activeLogs.filter(
          (l) => l.status === "borrowed",
        ).length;

        const usersCount = window.usersData.length || "-";

        document.getElementById("stat-total-items").innerText = totalItems;
        document.getElementById("stat-total-logs").innerText = totalLogsText;
        document.getElementById("stat-active-borrows").innerText =
          activeBorrows;
        document.getElementById("stat-users-count").innerText = usersCount;

        // If we haven't fetched all logs, we can't show accurate charts
        if (window.cachedAllLogs.length === 0) {
          return; // Exit early or show placeholder
        }

        const userCounts = {};
        const itemCounts = {};
        window.cachedAllLogs.forEach((log) => {
          userCounts[log.borrowerName] =
            (userCounts[log.borrowerName] || 0) + 1;
          itemCounts[log.itemName] = (itemCounts[log.itemName] || 0) + 1;
        });

        const topUsers = Object.entries(userCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        const topItems = Object.entries(itemCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        renderChart(
          "chart-users",
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°",
          topUsers,
          "rgba(54, 162, 235, 0.6)",
        );
        renderChart(
          "chart-items",
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°",
          topItems,
          "rgba(255, 206, 86, 0.6)",
        );

        const allItemsSorted = Object.entries(itemCounts).sort(
          (a, b) => b[1] - a[1],
        );
        const mostBorrowedList = document.getElementById("list-most-borrowed");
        const leastBorrowedList = document.getElementById(
          "list-least-borrowed",
        );

        mostBorrowedList.innerHTML = allItemsSorted
          .slice(0, 3)
          .map(
            ([name, count]) =>
              `<li class="flex justify-between"><span>${name}</span><span class="font-bold">${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></li>`,
          )
          .join("");

        const zeroBorrows = window.inventoryData.filter(
          (i) => !itemCounts[i.name],
        );
        leastBorrowedList.innerHTML =
          zeroBorrows
            .slice(0, 3)
            .map(
              (i) =>
                `<li class="flex justify-between"><span>${i.name}</span><span class="text-xs bg-gray-100 px-2 rounded">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></li>`,
            )
            .join("") ||
          '<li class="text-gray-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</li>';
      }

      let usersChartInstance = null;
      let itemsChartInstance = null;

      function renderChart(canvasId, label, dataEntries, color) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        if (canvasId === "chart-users" && usersChartInstance)
          usersChartInstance.destroy();
        if (canvasId === "chart-items" && itemsChartInstance)
          itemsChartInstance.destroy();

        const chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: dataEntries.map((e) => e[0]),
            datasets: [
              {
                label: label,
                data: dataEntries.map((e) => e[1]),
                backgroundColor: color,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1, precision: 0 },
              },
            },
          },
        });

        if (canvasId === "chart-users") usersChartInstance = chart;
        if (canvasId === "chart-items") itemsChartInstance = chart;
      }

      document
        .getElementById("search-inventory")
        .addEventListener("input", renderInventory);
      document
        .getElementById("filter-category")
        .addEventListener("change", renderInventory);
      document
        .getElementById("admin-filter-category")
        .addEventListener("change", renderAdminTable);

      function resizeImage(file, maxWidth = 800) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement("canvas");
              let w = img.width,
                h = img.height;
              if (w > maxWidth) {
                h = Math.round((h * maxWidth) / w);
                w = maxWidth;
              }
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL("image/jpeg", 0.7));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      document
        .getElementById("item-image-file")
        .addEventListener("change", async (e) => {
          if (e.target.files[0]) {
            const base64 = await resizeImage(e.target.files[0]);
            document.getElementById("item-image-preview").src = base64;
            document.getElementById("item-image-temp-base64").value = base64;
          }
        });

      (function () {
        if (localStorage.getItem(APP_CONFIG.storageKeys.theme) === "dark")
          document.documentElement.classList.add("dark");
        const storedUser = localStorage.getItem("ems_user_fb");
        if (storedUser) initApp(JSON.parse(storedUser));
        else {
          document.getElementById("login-screen").classList.remove("hidden");
          document.getElementById("app-screen").classList.add("hidden");
        }
      })();
    </script>
  </body>
</html>
