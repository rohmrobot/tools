<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ | Equipment Borrowing System</title>
    
    <!-- Google Fonts: Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Chart.js (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Kanit', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(30, 41, 59, 0.9); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .swal2-popup { font-family: 'Kanit', sans-serif !important; }
        .swal2-container.swal2-top-end { top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; right: auto !important; bottom: auto !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300 min-h-screen flex flex-col">

    <!-- ================= CONFIGURATION ================= -->
    <script>
        // FIX: ‡πÉ‡∏ä‡πâ window.APP_CONFIG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÉ‡∏ô module script
        window.APP_CONFIG = {
            useGoogleSheets: false, // ‡πÉ‡∏ä‡πâ Firebase ‡πÅ‡∏•‡πâ‡∏ß
            adminId: "9999", 
            storageKeys: {
                user: "ems_user_fb",
                theme: "ems_theme",
                localData: "ems_data_inventory",
                localLogs: "ems_data_logs"
            }
        };
    </script>

    <!-- ================= LOADING & STATUS ================= -->
    <div id="loading-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-2xl flex flex-col items-center gap-3">
            <i class="fas fa-circle-notch fa-spin text-primary-600 text-3xl"></i>
            <span class="font-medium text-gray-700 dark:text-gray-200">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
        </div>
    </div>

    <!-- ================= LOGIN SCREEN ================= -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-primary-600 to-blue-800 p-4 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all fade-in">
            <div class="text-center mb-8">
                <div class="bg-primary-100 dark:bg-primary-900 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-primary-600 dark:text-primary-300 shadow-inner">
                    <i class="fas fa-toolbox text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å-‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h1>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Equipment Management System (Firebase)</p>
            </div>
            <form id="login-form" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <div class="relative">
                        <i class="fas fa-id-card absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="text" id="login-id" required class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none transition" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 9999)">
                    </div>
                </div>
                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="text" id="login-name" required class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none transition" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3.5 rounded-lg shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- ================= MAIN APP ================= -->
    <div id="app-screen" class="hidden flex flex-col min-h-screen">
        <!-- Navbar -->
        <nav class="sticky top-0 z-40 glass border-b border-gray-200 dark:border-gray-700 shadow-sm">
            <div class="w-full px-4">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-3">
                        <div class="bg-primary-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-wrench text-sm"></i>
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="font-bold text-lg leading-tight tracking-tight">Tool<span class="text-primary-600 dark:text-primary-400">Master</span></span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wide">Firebase Realtime</span>
                                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" title="Online"></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 hover:text-orange-500 dark:hover:text-yellow-400 transition flex items-center justify-center">
                            <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
                        </button>
                        <div class="relative group z-50">
                            <button class="flex items-center gap-2 pl-2">
                                <div class="text-right hidden sm:block">
                                    <p id="user-display-name" class="text-sm font-semibold text-gray-900 dark:text-white truncate max-w-[120px]">User</p>
                                    <p id="user-display-role" class="text-xs text-gray-500 dark:text-gray-400">Staff</p>
                                </div>
                                <div class="w-9 h-9 rounded-full bg-primary-100 dark:bg-primary-900 border-2 border-white dark:border-gray-600 flex items-center justify-center text-primary-600 dark:text-primary-300">
                                    <i class="fas fa-user text-sm"></i>
                                </div>
                            </button>
                            <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl py-2 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all transform origin-top-right border border-gray-100 dark:border-gray-700">
                                <!-- Mobile User Info -->
                                <div class="px-4 py-2 border-b border-gray-100 dark:border-gray-700 sm:hidden">
                                    <p class="text-sm font-bold text-gray-900 dark:text-white" id="mobile-user-name">User</p>
                                    <p class="text-xs text-gray-500" id="mobile-user-role">Staff</p>
                                </div>
                                <button onclick="DataService.loadData()" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <i class="fas fa-sync-alt mr-2 text-blue-500"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                                <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">
                                    <i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Tabs -->
        <div class="bg-white dark:bg-dark-card shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-16 z-30">
            <div class="w-full px-4">
                <div class="flex space-x-2 overflow-x-auto no-scrollbar py-2">
                    <!-- ADMIN DASHBOARD TAB -->
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn hidden flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20">
                        <i class="fas fa-chart-pie"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                    </button>

                    <button onclick="switchTab('inventory')" id="tab-inventory" class="tab-btn active-tab flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all">
                        <i class="fas fa-box-open"></i> ‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á
                    </button>
                    <button onclick="switchTab('my-items')" id="tab-my-items" class="tab-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all relative">
                        <i class="fas fa-hand-holding"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏∑‡∏°
                        <span id="my-items-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800">0</span>
                    </button>
                    <button onclick="switchTab('verify')" id="tab-verify" class="tab-btn hidden flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all relative text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20">
                        <i class="fas fa-tasks"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                        <span id="verify-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800">0</span>
                    </button>
                    <button onclick="switchTab('history')" id="tab-history" class="tab-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all">
                        <i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    </button>
                    <button onclick="switchTab('admin')" id="tab-admin" class="tab-btn hidden flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-all text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20">
                        <i class="fas fa-cog"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <main class="flex-1 w-full px-4 py-6 pb-24">
            
            <!-- VIEW 0: DASHBOARD (ADMIN) -->
            <div id="view-dashboard" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-chart-line text-indigo-500"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö (Dashboard)</h2>
                    
                    <!-- Quota Estimation Bar -->
                    <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                <i class="fas fa-database text-orange-500 mr-1"></i> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
                            </span>
                            <span class="text-xs font-bold text-primary-600 dark:text-primary-400" id="quota-text">0 / 50,000 Reads</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 overflow-hidden">
                            <div id="quota-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2 text-right">* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô Session ‡∏ô‡∏µ‡πâ (Free Tier: 50k reads/day)</p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <div class="text-xs text-gray-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
                            <div class="text-2xl font-bold" id="stat-total-items">0</div>
                        </div>
                        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                            <div class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div class="text-2xl font-bold" id="stat-total-logs">0</div>
                        </div>
                        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                            <div class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</div>
                            <div class="text-2xl font-bold" id="stat-active-borrows">0</div>
                        </div>
                        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm border-l-4 border-indigo-500">
                            <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                            <div class="text-2xl font-bold" id="stat-users-count">-</div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Borrowers -->
                        <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm">
                            <h3 class="font-bold mb-4 text-sm text-gray-700 dark:text-gray-300">üèÜ ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 5)</h3>
                            <div class="relative h-64">
                                <canvas id="chart-users"></canvas>
                            </div>
                        </div>
                        
                        <!-- Top Items -->
                        <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm">
                            <h3 class="font-bold mb-4 text-sm text-gray-700 dark:text-gray-300">üì¶ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï (Top 5)</h3>
                            <div class="relative h-64">
                                <canvas id="chart-items"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Most/Least Borrowed Table -->
                    <div class="mt-6 bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="font-bold text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-green-600 font-bold text-xs uppercase mb-2">üî• ‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>
                                <ul id="list-most-borrowed" class="space-y-2 text-sm"></ul>
                            </div>
                            <div>
                                <h4 class="text-red-500 font-bold text-xs uppercase mb-2">‚ùÑÔ∏è ‡∏¢‡∏∑‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Zero Use)</h4>
                                <ul id="list-least-borrowed" class="space-y-2 text-sm text-gray-500"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 1: INVENTORY -->
            <div id="view-inventory" class="fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 whitespace-nowrap"><i class="fas fa-search text-primary-500"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
                    <div class="flex w-full md:w-auto gap-2">
                        <div class="relative w-1/3 md:w-48">
                            <select id="filter-category" class="w-full appearance-none pl-4 pr-8 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-primary-500 outline-none shadow-sm cursor-pointer">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 pointer-events-none text-xs"></i>
                        </div>
                        <div class="relative w-2/3 md:w-64">
                            <input type="text" id="search-inventory" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-primary-500 outline-none shadow-sm text-sm">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 sm:gap-6"></div>
            </div>

            <!-- VIEW 2: MY ITEMS -->
            <div id="view-my-items" class="hidden fade-in">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏∑‡∏°</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="returnAllItems()" id="btn-return-all" class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm shadow-md transition flex items-center gap-2">
                            <i class="fas fa-undo-alt"></i> ‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200 border-l-4 border-primary-500 pl-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏° (Active)</h3>
                    <div id="my-items-active-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <div id="my-items-active-empty" class="hidden text-center py-6 text-gray-400 text-sm bg-gray-50 dark:bg-gray-800 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200 border-l-4 border-yellow-500 pl-3">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (Pending Confirmation)</h3>
                    <div id="my-items-pending-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <div id="my-items-pending-empty" class="hidden text-center py-6 text-gray-400 text-sm bg-gray-50 dark:bg-gray-800 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
                </div>
            </div>

            <!-- VIEW 3: VERIFY (Admin) -->
            <div id="view-verify" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á</h2>
                    <button onclick="verifyAllReturns()" id="btn-verify-all" class="hidden bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm shadow-md transition flex items-center gap-2">
                        <i class="fas fa-check-double"></i> ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
                <div id="verify-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <div id="verify-empty" class="hidden text-center py-12 bg-white dark:bg-dark-card rounded-xl border border-dashed border-gray-300 dark:border-gray-700">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
            </div>

            <!-- VIEW 4: HISTORY -->
            <div id="view-history" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
                    <span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-gray-500" id="history-filter-label">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                </div>
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700 overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 border-b dark:border-gray-600">
                            <tr>
                                <th class="px-4 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th>
                                <th class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
                                <th class="px-4 py-3">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                                <th class="px-4 py-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="px-4 py-3 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW 5: ADMIN STOCK -->
            <div id="view-admin" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
                    <button onclick="openAddModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow text-sm"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
                </div>
                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700 overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-300 border-b dark:border-gray-600">
                            <tr>
                                <th class="px-4 py-3 w-16 text-center">‡∏£‡∏π‡∏õ</th>
                                <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                                <th class="px-4 py-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                <th class="px-4 py-3 text-center">Stock</th>
                                <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="borrow-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl shadow-2xl p-6">
            <div class="flex gap-4 mb-4">
                <img id="borrow-img-preview" src="" class="w-20 h-20 rounded-lg object-cover bg-gray-100">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white leading-tight mb-1" id="borrow-item-name"></h3>
                    <p class="text-xs text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="borrow-item-max" class="font-bold text-primary-600 text-base"></span></p>
                </div>
            </div>
            <div class="flex items-center justify-center gap-4 mb-6">
                <button onclick="adjustQty(-1)" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700"><i class="fas fa-minus"></i></button>
                <input type="number" id="borrow-qty" min="1" value="1" readonly class="w-16 text-center text-2xl font-bold bg-transparent outline-none">
                <button onclick="adjustQty(1)" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700"><i class="fas fa-plus"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeModal('borrow-modal')" class="py-3 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="btn-confirm-borrow" onclick="confirmBorrow()" class="py-3 rounded-xl bg-primary-600 text-white font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-2xl p-6 overflow-y-auto max-h-[90vh]">
            <h3 id="item-modal-title" class="text-lg font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
            <form id="item-form" class="space-y-4">
                <input type="hidden" id="item-id">
                
                <!-- Image Source Selection -->
                <div>
                    <label class="block text-sm mb-2 font-medium">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                    <div class="flex gap-4 mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="img-source" value="file" checked class="text-primary-600" onchange="toggleImageSource('file')">
                            <span class="text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="img-source" value="url" class="text-primary-600" onchange="toggleImageSource('url')">
                            <span class="text-sm">‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</span>
                        </label>
                    </div>

                    <div class="flex items-start gap-4 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800">
                         <div class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden border flex-shrink-0 relative group">
                             <img id="item-image-preview" src="https://placehold.co/100?text=Preview" class="w-full h-full object-cover">
                             <div id="upload-loading-spinner" class="absolute inset-0 bg-black/50 flex items-center justify-center hidden">
                                 <i class="fas fa-circle-notch fa-spin text-white"></i>
                             </div>
                         </div>
                         <div class="flex-1 min-w-0">
                             <div id="input-type-file">
                                 <label class="cursor-pointer bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg text-sm inline-flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-600 transition shadow-sm w-full justify-center">
                                    <i class="fas fa-camera"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                                    <input type="file" id="item-image-file" accept="image/*" class="hidden">
                                 </label>
                                 <p class="text-xs text-gray-400 mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG</p>
                             </div>
                             <div id="input-type-url" class="hidden">
                                 <input type="url" id="item-image-url" placeholder="https://example.com/image.jpg" class="w-full px-3 py-2 text-sm border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 outline-none">
                                 <p class="text-xs text-gray-400 mt-2">‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô</p>
                             </div>
                             <input type="hidden" id="item-image">
                         </div>
                    </div>
                </div>

                <input type="text" id="item-name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <input type="text" list="category-list" id="item-category" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                        <datalist id="category-list"></datalist>
                    </div>
                    <input type="number" id="item-stock" min="1" required placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Stock" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('item-modal')" class="px-4 py-2 text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="px-6 py-2 bg-primary-600 text-white rounded-lg shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ================= FIREBASE SDK ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
       const firebaseConfig = {
          apiKey: "AIzaSyCqP4PJZjifXa96NLdJ5Dd9A9AWLYcIiqs",
          authDomain: "borrow-tools-system.firebaseapp.com",
          projectId: "borrow-tools-system",
          storageBucket: "borrow-tools-system.firebasestorage.app",
          messagingSenderId: "1027262105690",
          appId: "1:1027262105690:web:0db3c601e67ef04a303063"
        };

        // Initialize Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Connected");
        } catch (e) {
            console.error("Firebase Config Error:", e);
            Swal.fire({ icon: 'error', title: 'Config Error', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Firebase Config' });
        }

        // --- GLOBAL STATE ---
        window.currentUser = null;
        window.inventoryData = [];
        window.transactionLogs = [];
        window.currentBorrowItemId = null;
        
        // Quota Tracking Variables
        window.quotaReads = 0;
        const QUOTA_LIMIT = 50000;

        // --- EXPORT FUNCTIONS ---
        window.switchTab = switchTab;
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleTheme = toggleTheme;
        window.adjustQty = (n) => {
            const el = document.getElementById('borrow-qty');
            let v = parseInt(el.value) + n;
            let max = parseInt(el.max || 1);
            if(v < 1) v = 1;
            if(v > max) v = max;
            el.value = v;
        };

        // --- FIX: DataService ---
        window.DataService = {
            loadData: () => {
                const icon = document.querySelector('.fa-sync-alt');
                if(icon) {
                    icon.classList.add('fa-spin');
                    setTimeout(() => icon.classList.remove('fa-spin'), 1000);
                }
            },
            // Background save placeholder (Firebase uses direct SDK calls)
            saveData: async () => true
        };

        // --- AUTH ---
        window.login = async (e) => {
            e.preventDefault();
            const inputId = document.getElementById('login-id').value.trim();
            const inputName = document.getElementById('login-name').value.trim();
            if(!inputId) return;

            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                // Auth by checking 'users' collection
                window.quotaReads++; // Count read
                const q = query(collection(db, "users"), where("empId", "==", inputId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const userData = querySnapshot.docs[0].data();
                    const user = {
                        empId: userData.empId,
                        name: userData.name, // Use name from DB
                        isAdmin: userData.role === 'admin'
                    };
                    localStorage.setItem('ems_user_fb', JSON.stringify(user));
                    initApp(user);
                } else {
                    // Auto-register logic
                    const newUser = {
                        empId: inputId,
                        name: inputName || `User ${inputId}`,
                        role: inputId === '9999' ? 'admin' : 'user'
                    };

                    try {
                        await addDoc(collection(db, "users"), newUser);
                    } catch(err) {
                        console.warn("Auto-register failed:", err);
                    }

                    const user = { ...newUser, isAdmin: newUser.role === 'admin' };
                    localStorage.setItem('ems_user_fb', JSON.stringify(user));
                    initApp(user);
                }
            } catch (err) {
                console.error(err);
                Swal.fire('Login Error', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Config Firebase', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        document.getElementById('login-form').addEventListener('submit', window.login);

        window.logout = () => {
            localStorage.removeItem('ems_user_fb');
            location.reload();
        };

        function initApp(user) {
            window.currentUser = user;
            
            document.getElementById('user-display-name').innerText = user.name;
            document.getElementById('user-display-role').innerText = user.isAdmin ? "Admin" : "User";
            
            const mobileName = document.getElementById('mobile-user-name');
            if (mobileName) mobileName.innerText = user.name;
            const mobileRole = document.getElementById('mobile-user-role');
            if (mobileRole) mobileRole.innerText = user.isAdmin ? "Admin" : "User";

            const adminTab = document.getElementById('tab-admin');
            const verifyTab = document.getElementById('tab-verify');
            const dashboardTab = document.getElementById('tab-dashboard'); // New Tab

            if (user.isAdmin) {
                adminTab.classList.remove('hidden');
                verifyTab.classList.remove('hidden');
                dashboardTab.classList.remove('hidden');
            } else {
                adminTab.classList.add('hidden');
                verifyTab.classList.add('hidden');
                dashboardTab.classList.add('hidden');
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');

            startRealtimeListeners();
            switchTab('inventory');
        }

        // --- REALTIME LISTENERS & QUOTA TRACKING ---
        function updateQuotaUI() {
            const bar = document.getElementById('quota-bar');
            const text = document.getElementById('quota-text');
            if(bar && text) {
                const percent = Math.min((window.quotaReads / QUOTA_LIMIT) * 100, 100);
                bar.style.width = `${percent}%`;
                bar.classList.toggle('from-green-400', percent < 50);
                bar.classList.toggle('to-blue-500', percent < 50);
                bar.classList.toggle('bg-red-500', percent >= 90);
                text.innerText = `${window.quotaReads.toLocaleString()} / ${QUOTA_LIMIT.toLocaleString()} Reads`;
            }
        }

        function startRealtimeListeners() {
            // Inventory
            onSnapshot(collection(db, "inventory"), (snapshot) => {
                window.quotaReads += snapshot.docChanges().length; // Approximate read count on change
                updateQuotaUI();
                
                window.inventoryData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventory();
                if(window.currentUser.isAdmin) {
                    renderAdminTable();
                    renderDashboard(); // Update Dashboard
                }
                populateCategories();
            });

            // Logs
            onSnapshot(collection(db, "logs"), (snapshot) => {
                window.quotaReads += snapshot.docChanges().length;
                updateQuotaUI();

                window.transactionLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory();
                renderMyItems();
                if(window.currentUser.isAdmin) {
                    renderVerify();
                    renderDashboard(); // Update Dashboard
                }
            });
        }

        // --- DASHBOARD LOGIC (NEW) ---
        let usersChartInstance = null;
        let itemsChartInstance = null;

        function renderDashboard() {
            if (!window.currentUser.isAdmin) return;

            // 1. Calculate Stats
            const totalItems = window.inventoryData.reduce((sum, i) => sum + i.stock, 0);
            const totalLogs = window.transactionLogs.length;
            const activeBorrows = window.transactionLogs.filter(l => l.status === 'borrowed').length;
            
            // Calculate Unique Users (Count distinct empId from logs)
            const uniqueUsers = new Set(window.transactionLogs.map(l => l.empId)).size;
            
            // Set Stats Cards
            document.getElementById('stat-total-items').innerText = totalItems;
            document.getElementById('stat-total-logs').innerText = totalLogs;
            document.getElementById('stat-active-borrows').innerText = activeBorrows;
            document.getElementById('stat-users-count').innerText = uniqueUsers; // Updated here

            // 2. Prepare Data for Charts
            const userCounts = {};
            const itemCounts = {};
            
            window.transactionLogs.forEach(log => {
                // Count by User
                userCounts[log.borrowerName] = (userCounts[log.borrowerName] || 0) + 1;
                // Count by Item
                itemCounts[log.itemName] = (itemCounts[log.itemName] || 0) + 1;
            });

            // Top Users
            const topUsers = Object.entries(userCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            // Top Items
            const topItems = Object.entries(itemCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // 3. Render Charts
            renderChart('chart-users', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°', topUsers, 'rgba(54, 162, 235, 0.6)');
            renderChart('chart-items', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°', topItems, 'rgba(255, 206, 86, 0.6)');

            // 4. Most/Least Borrowed Table
            const allItemsSorted = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
            const mostBorrowedList = document.getElementById('list-most-borrowed');
            const leastBorrowedList = document.getElementById('list-least-borrowed');
            
            mostBorrowedList.innerHTML = allItemsSorted.slice(0, 3).map(([name, count]) => 
                `<li class="flex justify-between"><span>${name}</span><span class="font-bold">${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></li>`
            ).join('');

            // Find items with 0 borrows
            const zeroBorrows = window.inventoryData.filter(i => !itemCounts[i.name]);
            leastBorrowedList.innerHTML = zeroBorrows.slice(0, 3).map(i => 
                `<li class="flex justify-between"><span>${i.name}</span><span class="text-xs bg-gray-100 px-2 rounded">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></li>`
            ).join('') || '<li class="text-gray-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</li>';
        }

        function renderChart(canvasId, label, dataEntries, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy old chart if exists
            if (canvasId === 'chart-users' && usersChartInstance) usersChartInstance.destroy();
            if (canvasId === 'chart-items' && itemsChartInstance) itemsChartInstance.destroy();

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dataEntries.map(e => e[0]),
                    datasets: [{
                        label: label,
                        data: dataEntries.map(e => e[1]),
                        backgroundColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1, // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 1
                                precision: 0 // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
                            }
                        } 
                    }
                }
            });

            if (canvasId === 'chart-users') usersChartInstance = chart;
            if (canvasId === 'chart-items') itemsChartInstance = chart;
        }

        // --- CORE LOGIC (Standard) ---
        window.openBorrowModal = (id) => {
            const item = window.inventoryData.find(i => i.id == id);
            if (!item) return;
            window.currentBorrowItemId = id;
            document.getElementById('borrow-item-name').innerText = item.name;
            document.getElementById('borrow-item-max').innerText = item.remaining;
            document.getElementById('borrow-img-preview').src = item.image || "https://placehold.co/100";
            document.getElementById('borrow-qty').max = item.remaining;
            document.getElementById('borrow-qty').value = 1;
            document.getElementById('borrow-modal').classList.remove('hidden');
        };

        window.confirmBorrow = async () => {
            const qty = parseInt(document.getElementById('borrow-qty').value);
            const itemId = window.currentBorrowItemId;
            const btn = document.getElementById('btn-confirm-borrow');
            btn.disabled = true; btn.innerText = '...';

            try {
                await runTransaction(db, async (transaction) => {
                    const itemRef = doc(db, "inventory", itemId);
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists()) throw "Item does not exist!";
                    const currentRemaining = itemDoc.data().remaining;
                    if (currentRemaining < qty) throw "‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!";
                    transaction.update(itemRef, { remaining: currentRemaining - qty });
                    const newLogRef = doc(collection(db, "logs"));
                    transaction.set(newLogRef, {
                        itemId: itemId,
                        itemName: itemDoc.data().name,
                        borrowerName: window.currentUser.name,
                        empId: window.currentUser.empId,
                        borrowDate: new Date().toISOString(),
                        status: 'borrowed',
                        qty: qty,
                        returnDate: null
                    });
                });
                closeModal('borrow-modal');
                Swal.fire({ icon: 'success', title: '‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
            } catch (e) { Swal.fire('Error', e.toString(), 'error'); } 
            finally { btn.disabled = false; btn.innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'; }
        };

        window.requestReturn = async (logId) => {
            const result = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô?', icon: 'question', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' });
            if (result.isConfirmed) {
                try { await updateDoc(doc(db, "logs", logId), { status: 'pending_return' }); } catch (e) { console.error(e); }
            }
        };

        window.returnAllItems = async () => {
            const result = await Swal.fire({ title: '‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' });
            if(result.isConfirmed) {
                const batch = writeBatch(db);
                let count = 0;
                window.transactionLogs.forEach(log => {
                    if(log.empId == window.currentUser.empId && log.status === 'borrowed') {
                        batch.update(doc(db, "logs", log.id), { status: 'pending_return' });
                        count++;
                    }
                });
                if(count > 0) await batch.commit();
            }
        };

        window.adminConfirmReturn = async (logId) => {
            try {
                await runTransaction(db, async (transaction) => {
                    const logRef = doc(db, "logs", logId);
                    const logDoc = await transaction.get(logRef);
                    if (!logDoc.exists()) throw "Log not found";
                    const logData = logDoc.data();
                    const itemRef = doc(db, "inventory", logData.itemId);
                    const itemDoc = await transaction.get(itemRef);
                    transaction.update(logRef, { status: 'returned', returnDate: new Date().toISOString() });
                    if (itemDoc.exists()) {
                        transaction.update(itemRef, { remaining: (itemDoc.data().remaining || 0) + logData.qty });
                    }
                });
            } catch (e) { Swal.fire('Error', e.toString(), 'error'); }
        };

        window.verifyAllReturns = async () => {
            const pending = window.transactionLogs.filter(l => l.status === 'pending_return');
            for (const log of pending) await window.adminConfirmReturn(log.id);
            Swal.fire({ icon: 'success', title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
        };

        // --- LOG MANAGEMENT (DELETE) ---
        window.deleteLog = async (logId) => {
            const result = await Swal.fire({
                title: '‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?',
                text: "‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Stock ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£'
            });
            if(result.isConfirmed) {
                try {
                    await deleteDoc(doc(db, "logs", logId));
                    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1000, showConfirmButton: false });
                } catch(e) {
                    Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Rules)', 'error');
                }
            }
        }

        // --- ADMIN: ITEM MANAGEMENT ---
        document.getElementById('item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const name = document.getElementById('item-name').value;
            const category = document.getElementById('item-category').value;
            const stock = parseInt(document.getElementById('item-stock').value);
            
            const sourceType = document.querySelector('input[name="img-source"]:checked').value;
            let image = sourceType === 'file' ? document.getElementById('item-image').value : document.getElementById('item-image-url').value;
            if(!image) image = "https://placehold.co/300x200?text=No+Image";

            const itemData = { name, category, stock, image };

            try {
                if (id) {
                    const oldItem = window.inventoryData.find(i => i.id == id);
                    const borrowed = oldItem.stock - oldItem.remaining;
                    itemData.remaining = stock - borrowed;
                    await updateDoc(doc(db, "inventory", id), itemData);
                } else {
                    itemData.remaining = stock;
                    await addDoc(collection(db, "inventory"), itemData);
                }
                closeModal('item-modal');
                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
            } catch (e) { console.error(e); }
        });

        window.toggleImageSource = (type) => {
            document.getElementById('input-type-file').classList.toggle('hidden', type !== 'file');
            document.getElementById('input-type-url').classList.toggle('hidden', type !== 'url');
        };
        document.getElementById('item-image-url').addEventListener('input', (e) => {
            if(e.target.value) document.getElementById('item-image-preview').src = e.target.value;
        });

        window.openAddModal = () => {
            document.getElementById('item-modal-title').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà";
            document.getElementById('item-form').reset();
            document.getElementById('item-id').value = "";
            document.getElementById('item-image').value = "";
            document.getElementById('item-image-preview').src = "https://placehold.co/100?text=Preview";
            document.querySelector('input[name="img-source"][value="file"]').checked = true;
            window.toggleImageSource('file');
            document.getElementById('item-modal').classList.remove('hidden');
        };

        window.editItem = (id) => {
            const item = window.inventoryData.find(i => i.id == id);
            document.getElementById('item-modal-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå";
            document.getElementById('item-id').value = id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-stock').value = item.stock;
            
            const isUrl = item.image && item.image.startsWith('http') && !item.image.startsWith('data:');
            document.querySelector(`input[name="img-source"][value="${isUrl ? 'url' : 'file'}"]`).checked = true;
            window.toggleImageSource(isUrl ? 'url' : 'file');
            
            if(isUrl) document.getElementById('item-image-url').value = item.image;
            else document.getElementById('item-image').value = item.image;
            
            document.getElementById('item-image-preview').src = item.image || "https://placehold.co/100";
            document.getElementById('item-modal').classList.remove('hidden');
        };

        window.deleteItem = async (id) => {
            const result = await Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö' });
            if(result.isConfirmed) await deleteDoc(doc(db, "inventory", id));
        };

        // --- RENDER FUNCTIONS ---
        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            const search = document.getElementById('search-inventory').value.toLowerCase();
            const catFilter = document.getElementById('filter-category').value;
            grid.innerHTML = '';
            const items = window.inventoryData.filter(i => {
                const matchName = i.name.toLowerCase().includes(search);
                const matchCat = catFilter ? i.category === catFilter : true;
                return matchName && matchCat;
            });
            items.forEach(item => {
                const isOut = item.remaining <= 0;
                grid.innerHTML += `
                    <div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm hover:shadow-md transition border border-gray-100 dark:border-gray-700 flex flex-col h-full group overflow-hidden">
                        <div class="h-40 overflow-hidden relative bg-gray-100 dark:bg-gray-800">
                            <img src="${item.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                            <span class="absolute top-2 right-2 px-2 py-1 text-xs font-bold rounded-full ${isOut ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} shadow-sm">
                                ${isOut ? '‡∏´‡∏°‡∏î' : `‡∏ß‡πà‡∏≤‡∏á ${item.remaining}`}
                            </span>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <div class="text-xs text-gray-400 mb-1">${item.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</div>
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg mb-1 leading-snug line-clamp-2">${item.name}</h3>
                            <div class="flex-1"></div>
                            <button onclick="openBorrowModal('${item.id}')" ${isOut ? 'disabled' : ''} class="mt-4 w-full py-2.5 rounded-xl font-medium transition flex items-center justify-center gap-2 ${isOut ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-primary-600 text-white hover:bg-primary-700 shadow-lg'}">
                                ${isOut ? '‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î' : '‡∏¢‡∏∑‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ'}
                            </button>
                        </div>
                    </div>`;
            });
        }

        // ... renderMyItems, renderVerify, renderAdminTable, populateCategories (Same as before) ...
        function renderMyItems() {
            const activeList = document.getElementById('my-items-active-list');
            const pendingList = document.getElementById('my-items-pending-list');
            const badge = document.getElementById('my-items-badge');
            const returnAllBtn = document.getElementById('btn-return-all');
            
            activeList.innerHTML = ''; pendingList.innerHTML = '';
            
            const myLogs = window.transactionLogs.filter(l => l.empId == window.currentUser.empId);
            const active = myLogs.filter(l => l.status === 'borrowed');
            const pending = myLogs.filter(l => l.status === 'pending_return');

            document.getElementById('my-items-active-empty').classList.toggle('hidden', active.length > 0);
            document.getElementById('my-items-pending-empty').classList.toggle('hidden', pending.length > 0);

            if(active.length > 0) {
                badge.classList.remove('hidden'); badge.innerText = active.length;
                returnAllBtn.classList.remove('hidden');
            } else {
                badge.classList.add('hidden'); returnAllBtn.classList.add('hidden');
            }

            const createCard = (log, isActive) => {
                const item = window.inventoryData.find(i => i.id == log.itemId) || {};
                const date = new Date(log.borrowDate).toLocaleDateString('th-TH');
                const btn = isActive ? 
                    `<button onclick="requestReturn('${log.id}')" class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow"><i class="fas fa-undo"></i></button>` : 
                    `<div class="text-yellow-500 text-xl"><i class="fas fa-clock"></i></div>`;
                return `
                    <div class="bg-white dark:bg-dark-card p-4 rounded-xl border-l-4 ${isActive?'border-primary-500':'border-yellow-500'} shadow-sm flex items-center gap-4">
                        <img src="${item.image || 'https://placehold.co/100'}" class="w-16 h-16 rounded-lg object-cover bg-gray-100">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-900 dark:text-white truncate">${log.itemName}</h4>
                            <div class="text-xs text-gray-500 mt-1">‡∏¢‡∏∑‡∏°: ${date}</div>
                            <div class="mt-2"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-md font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${log.qty}</span></div>
                        </div>
                        ${btn}
                    </div>`;
            };

            active.forEach(l => activeList.innerHTML += createCard(l, true));
            pending.forEach(l => pendingList.innerHTML += createCard(l, false));
        }

        function renderVerify() {
            const list = document.getElementById('verify-list');
            const badge = document.getElementById('verify-badge');
            const verifyAllBtn = document.getElementById('btn-verify-all');
            list.innerHTML = '';
            const pending = window.transactionLogs.filter(l => l.status === 'pending_return');
            
            if(pending.length > 0) {
                badge.classList.remove('hidden'); badge.innerText = pending.length;
                verifyAllBtn.classList.remove('hidden');
            } else {
                badge.classList.add('hidden'); verifyAllBtn.classList.add('hidden');
            }
            document.getElementById('verify-empty').classList.toggle('hidden', pending.length > 0);

            pending.forEach(log => {
                const item = window.inventoryData.find(i => i.id == log.itemId) || {};
                list.innerHTML += `
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-md overflow-hidden border border-yellow-200">
                        <div class="flex p-4 gap-4">
                            <img src="${item.image || 'https://placehold.co/100'}" class="w-20 h-20 rounded-lg object-cover">
                            <div class="flex-1">
                                <h4 class="font-bold dark:text-white">${log.itemName}</h4>
                                <div class="text-sm text-gray-500">${log.borrowerName} (${log.empId})</div>
                                <div class="text-xs text-gray-400 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${log.qty}</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 flex justify-end">
                            <button onclick="adminConfirmReturn('${log.id}')" class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-sm flex items-center gap-2"><i class="fas fa-check"></i> ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</button>
                        </div>
                    </div>`;
            });
        }

        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            let logs = window.transactionLogs;
            if(!window.currentUser.isAdmin) logs = logs.filter(l => l.empId == window.currentUser.empId);
            logs.sort((a,b) => new Date(b.borrowDate) - new Date(a.borrowDate));

            logs.forEach(log => {
                const status = log.status === 'borrowed' ? '<span class="text-blue-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</span>' : log.status === 'pending_return' ? '<span class="text-yellow-500">‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô</span>' : '<span class="text-green-500">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
                const deleteBtn = window.currentUser.isAdmin ? 
                    `<button onclick="deleteLog('${log.id}')" class="text-red-400 hover:text-red-600 ml-2" title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"><i class="fas fa-trash-alt"></i></button>` : '';
                
                tbody.innerHTML += `
                    <tr class="bg-white dark:bg-dark-card border-b dark:border-gray-700">
                        <td class="px-4 py-3">${new Date(log.borrowDate).toLocaleDateString('th-TH')}</td>
                        <td class="px-4 py-3">${log.borrowerName}</td>
                        <td class="px-4 py-3">${log.itemName}</td>
                        <td class="px-4 py-3 text-center">${log.qty}</td>
                        <td class="px-4 py-3 text-center">${status}</td>
                        <td class="px-4 py-3 text-center">
                            ${log.returnDate ? new Date(log.returnDate).toLocaleDateString('th-TH') : '-'}
                            ${deleteBtn}
                        </td>
                    </tr>`;
            });
        }

        function renderAdminTable() {
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = '';
            window.inventoryData.forEach(item => {
                tbody.innerHTML += `
                    <tr class="bg-white border-b dark:bg-dark-card dark:border-gray-700">
                        <td class="px-4 py-3 text-center"><img src="${item.image}" class="w-10 h-10 rounded object-cover mx-auto"></td>
                        <td class="px-4 py-3">${item.name}</td>
                        <td class="px-4 py-3">${item.category}</td>
                        <td class="px-4 py-3 text-center">${item.remaining}/${item.stock}</td>
                        <td class="px-4 py-3 text-center space-x-2">
                            <button onclick="editItem('${item.id}')" class="text-primary-600"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem('${item.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function populateCategories() {
            const select = document.getElementById('filter-category');
            const dl = document.getElementById('category-list');
            select.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
            dl.innerHTML = '';
            const cats = [...new Set(window.inventoryData.map(i => i.category).filter(Boolean))];
            cats.forEach(c => {
                select.innerHTML += `<option value="${c}">${c}</option>`;
                dl.innerHTML += `<option value="${c}">`;
            });
        }

        document.getElementById('search-inventory').addEventListener('input', renderInventory);
        document.getElementById('filter-category').addEventListener('change', renderInventory);

        // --- UTILS ---
        function resizeImage(file, maxWidth = 800) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        document.getElementById('item-image-file').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                const base64 = await resizeImage(e.target.files[0]);
                document.getElementById('item-image-preview').src = base64;
                document.getElementById('item-image').value = base64;
            }
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active-tab', 'bg-primary-50', 'text-primary-600', 'dark:bg-primary-900/30', 'dark:text-primary-400', 'bg-yellow-50', 'text-yellow-600', 'dark:text-yellow-400');
                if(b.id === 'tab-verify') {
                    b.classList.remove('text-yellow-600', 'dark:text-yellow-400', 'bg-yellow-50', 'dark:bg-yellow-900/20');
                } else if(b.id === 'tab-dashboard') {
                    b.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-50', 'dark:bg-indigo-900/20');
                }
                b.classList.add('text-gray-500', 'dark:text-gray-400');
            });

            const btn = document.getElementById(`tab-${tab}`);
            btn.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            if(tab === 'verify') btn.classList.add('active-tab', 'bg-yellow-50', 'text-yellow-600', 'dark:bg-yellow-900/30', 'dark:text-yellow-400');
            else if(tab === 'dashboard') btn.classList.add('active-tab', 'bg-indigo-50', 'text-indigo-600', 'dark:bg-indigo-900/30', 'dark:text-indigo-400');
            else btn.classList.add('active-tab', 'bg-primary-50', 'text-primary-600', 'dark:bg-primary-900/30', 'dark:text-primary-400');
            
            ['inventory', 'my-items', 'verify', 'history', 'admin', 'dashboard'].forEach(v => {
                document.getElementById(`view-${v}`).classList.toggle('hidden', v !== tab);
            });
            
            if(tab === 'my-items') renderMyItems();
            if(tab === 'history') renderHistory();
            if(tab === 'verify') renderVerify();
            if(tab === 'dashboard') renderDashboard();
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem(APP_CONFIG.storageKeys.theme, 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem(APP_CONFIG.storageKeys.theme, 'dark');
            }
        }

        // --- INIT ---
        (function() {
            if (localStorage.getItem(APP_CONFIG.storageKeys.theme) === 'dark') document.documentElement.classList.add('dark');
            const storedUser = localStorage.getItem('ems_user_fb');
            if(storedUser) initApp(JSON.parse(storedUser));
            else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        })();

    </script>
</body>
</html>
